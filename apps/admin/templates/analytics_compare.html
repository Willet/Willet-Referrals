{% extends "admin_base.html" %}

{% block head %}
    <script type="text/javascript" src="{{ URL }}/static/js/jquery-ui-1.8.16.custom.min.js"></script>
    <script type="text/javascript" src="{{ URL }}/static/js/jquery.timeago.js"></script>
    <script type="text/javascript" src="{{ URL }}/static/js/highcharts.js"></script>
    <style type="text/css">
        td {
            font-size: 12px;
            vertical-align: top;
        }
        .scroll {
            overflow: scroll;
            max-width: 850px;
        }
        #space {
            padding-bottom: 100px;
        }
        input[type="checkbox"] {
            display: none;
        }
        input[type="checkbox"] + label:hover {
            border: 1px solid rgba(0,0,0,0.5);
        }
        input[type="checkbox"] + label {
            border: 1px solid transparent;
            padding: 3px;
            background-color: rgba(240,35,17,0.25); 
            border-radius: 5px;
            display:inline-block;
            margin: 2px;
            cursor: pointer;
            text-shadow: 1px 1px 0px rgba(0, 0, 0, 0.1);
        }
        input[type="checkbox"]:checked + label {
            background-color: rgba(195,255,104,0.75); 
        }
        h3 {
            cursor: pointer; 
        }
        span.mapreduce_link {
            color: blue;
            border-bottom: 1px dashed blue; 
            cursor: pointer;
        }
        span.mapreduce_link:hover {
            border-bottom: 1px solid grey;
            color: black;
        }
        span.mapreduce_link:active {
            border-bottom: 1px solid black;
            color: grey;
        }
    </style>
    <script type="text/javascript">
        var actions = {{ actions }}
        , series = [ 
            {% for action in actions %}
                {
                    name: '{{ action }}',
                    id: '{{ action }}',
                    data: []
                },
            {% endfor %}
        ]
        , chart
        , offset = 0
        , limit = 3
        , apps = []
        , row = 'even'
        , handle_message = function(source, data){
            var el = $(document.createElement('li'));
            el.addClass('row_' + row);
            row = (row == 'even' ? 'odd' : 'even');
            var html = '<span class="rpc_result '+data.success+'">' + data.success + '</span>';
            html += "<strong>" + source + "</strong><br />";
            if (data.message) {
                html += '<em>' + data.message + '</em><br />';
            }
            if (data.mapreduce_id) {
                html += '<em>Started mapreduce job </em><span id="' + 
                    data.mapreduce_id + '" class="mapreduce_link">' + 
                    data.mapreduce_id + '</span> status: ' + 
                    '<span class="mapreduce_status" id="status_for_' + 
                    data.mapreduce_id+'"></span>';
            }
            html += '</li>';
            el.html(html);
            $('#messages ul').append(el);
            $('#messages').slideDown('fast');
        };
        $(document).ready(function() {
            var update_chart = function() {
                /*
                chart = new Highcharts.Chart({
                    chart: {
                        renderTo: 'container',
                        type: 'spline'
                    },
                    legend: {
                        enabled: false
                    },
                    title: {
                        text: 'Actions over time'
                    },
                    xAxis: {
                        type: 'datetime',
                        dateTimeLabelFormats: {
                            hour: '%b %e %H', 
                            day: '%b %e',
                            month: '%b %e',
                            year: '%b %e'
                        },
                        tickInterval:24 * 3600 * 1000 
                    },
                    yAxis: {
                        title: {
                            text: 'Count'
                        },
                        min: 0
                    },
                    series: series,
                });
                */
            };
            var add_app = function(obj) {
                if (typeof  obj.app === undefined) {
                    console.error('obj.app may not be undefined', obj);
                    return -1;
                }
                var offset = app.offset || 0;
                var limit = app.limit || 3;
                var url = '{{ URL }}/analytics/' + app + '/rpc';
                $.getJSON(url, {
                        offset: offset,
                        limit: limit
                }, function(data){
                    console.log(data);
                    //offset += limit;
                    //$('#data').empty();
                    var app_data = $('#' + data.app.uuid + '_data');
                    var app_dates = $('#' + data.app.uuid + '_dates');
                    for (i = 0; i < data.data.length; i++) {
                        var row = $(document.createElement('tr'));
                        var since = $(document.createElement('tr'));
                        var row_date = data.data[i]['start_day'];
                        var since_html = '<td><abbr class="timeago" title="'+row_date+'"></abbr></td>'
                        row.hide();
                        since.hide();
                        var html = ''
                        var count = 0
                        for (j = 0; j < actions.length; j++) {
                            count = data.data[i][actions[j]];
                            if (actions[j] != series[j].name) {
                                console.log('error: whoops!', actions[j], series[j]);
                            }
                            $('#' + actions[j]).data('series-id', j);
                            series[j].data.push([Date.parse(row_date), count]);
                            html += '<td class="'+actions[j]+'">'+ count + '</td>';
                        }
                        row.html(html);
                        since.html(since_html);
                        app_data.append(row);
                        app_dates.append(since);
                        row.slideDown('fast');
                        since.slideDown('fast');
                    }
                    $('abbr.timeago').timeago();
                    // okay we added the data
                    // now we need to add the series to the chart
                    // in the format:
                    // APPUUID_ACTIONNAME
                });
            };
            var load_remote_data = function(obj) {
                if (typeof  obj.app === undefined) {
                    console.error('obj.app may not be undefined', obj);
                    return -1;
                }
                var offset = app.offset || 0;
                var limit = app.limit || 3;
                var url = '{{ URL }}/analytics/' + app + '/rpc';
                $.getJSON(url, {
                        offset: offset,
                        limit: limit
                }, function(data){
                    console.log(data);
                    //offset += limit;
                    //$('#data').empty();
                    var app_data = $('#' + data.app.uuid + '_data');
                    var app_dates = $('#' + data.app.uuid + '_dates');
                    for (i = 0; i < data.data.length; i++) {
                        var row = $(document.createElement('tr'));
                        var since = $(document.createElement('tr'));
                        var row_date = data.data[i]['start_day'];
                        var since_html = '<td><abbr class="timeago" title="'+row_date+'"></abbr></td>'
                        row.hide();
                        since.hide();
                        var html = ''
                        var count = 0
                        for (j = 0; j < actions.length; j++) {
                            count = data.data[i][actions[j]];
                            if (actions[j] != series[j].name) {
                                console.log('error: whoops!', actions[j], series[j]);
                            }
                            $('#' + actions[j]).data('series-id', j);
                            series[j].data.push([Date.parse(row_date), count]);
                            html += '<td class="'+actions[j]+'">'+ count + '</td>';
                        }
                        row.html(html);
                        since.html(since_html);
                        app_data.append(row);
                        app_dates.append(since);
                        row.slideDown('fast');
                        since.slideDown('fast');
                    }
                    $('abbr.timeago').timeago();
                    update_chart();
                }); 
            };
            $('#showing_actions input').click(function(e){
                var el = $(this);
                var series_id = el.data('series-id');
                var chart_series = chart.series[series_id];
                if (el.attr('checked') == 'checked') {
                    $('.' + el.attr('id')).show();
                    chart_series.show();
                } else {
                    $('.' + el.attr('id')).hide();
                    chart_series.hide();
                }
            });

            $('#more').click(function(e){
                load_remote_data();     
            });

                        $('h3').click(function(e){
                $(this).next('div').toggle();
            });

            $('span.mapreduce_link').live('click', function(e){
                var mapreduce_id = $(this).attr('id');

                // do an ajax query to GAE maprduce here
                $.getJSON('{{ URL }}/mapreduce/command/get_job_detail?mapreduce_id=' + mapreduce_id, function(data) {
                    var update_el = $('#status_for_' + data.mapreduce_id);
                    update_el.html(data.name + ' ' + data.result_status);
                });
            });

            load_remote_data();
        });

    </script>
{% endblock %}

{% block bottom_content %}
    <div class="span-24 prepend-top">
        <h1 class="prepend-top center">Comparing Analytics</h1>
        <div id="app_ac_container" class="span-24">
            Add an app: <input id="app_ac" />
        </div>
        <div id="container" class="span-24"></div>
        <h3>Filters</h3>
        <div class="span-24 last clear hidden" id='showing_actions'>
            {% for action in actions %}
                <input checked="checked" type="checkbox" id="{{ action }}" name="{{ action }}" /><label for="{{ action }}">{{ action }}</label>
            {% endfor %}
        </div>
        <h3>Apps</h3>
        <div class="span-24" id="app_container">
            <h3>App name<span class='remove'>x</span></h3>
            <table width='950px' cellpadding='0' cellspacing='0'>
                <tbody>
                    <tr>
                        <td>
                            <table width="100%" cellpadding='0' cellspacing='0'>
                                <thead><tr><th>Date</th></tr></thead>
                                <tbody id='" + app_uuid + "_dates'>

                                </tbody>
                            </table>
                        </td>
                        <td class='scroll'>
                            <table width='100%' cellpadding='0' cellspacing='0'>
                                <thead>
                                    <tr>
                                        {% for action in actions %}
                                            <th class="{{ action }}">{{ action }}</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody id='" + app_uuid + "_data'></tbody>
                            </table>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <h3>Actions</h3>
        <div class="span-24 hidden">
            <button id="more">Load more data</button>
        </div>
        <h3>Messages</h3>
        <div id="messages" class="hidden span-24">
            <ul></ul>
        </div>
    </div>
    <div id="space">&nbsp;</div>
{% endblock bottom_content %}

