<!DOCTYPE html>
<html lang='en'>
    <head>
        <!-- Google Analytics -->
        <script type="text/javascript">
            var _gaq = _gaq || [];
            _gaq.push(['_setAccount', 'UA-23764505-9']);
            _gaq.push(['_trackPageview']);
            (function() {
                var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
                ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
            })();
        </script>
        
        <!-- Favicon -->
        <link rel='icon' type='image/vnd.microsoft.icon' href='/static/imgs/favicon.ico' />
        
        <meta http-equiv="X-UA-Compatible" content="IE=8" />
        <meta http-equiv='Content-Type' content='text/html;charset=utf-8' />
        <title>Social Referral</title>
        <link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
                    
        <script type="text/javascript" src="http://platform.tumblr.com/v1/share.js"></script>
        <script type="text/javascript" src="http://assets.pinterest.com/js/pinit.js"></script>
        <script src="http://svpply.com/api/all.js#xsvml=1" type="text/javascript"></script>

        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js" type="text/javascript"></script>
        <script src="http://connect.facebook.net/en_US/all.js" type="text/javascript"></script> 
        
        <script type="text/javascript">
            var userFound;

            var _wait_for_fb = function() {
                if (typeof window.FB == 'object') {
                    FB.init({ appId: '{{FACEBOOK_APP_ID}}',
                        status: true,
                        cookie: true,
                        xfbml: true,
                        oauth: true
                    });
                } else {
                    console.log('FB not loaded yet');
                    setTimeout('_wait_for_fb()', 100);
                }
            };
            var fb_share_handler = function(payload) {
                console.log(payload)
                var btn = document.getElementById( '_willet_want' );
                btn.value = "Wanting ...";
                $.ajax({
                url: "/b/action/want/product/",
                    type: 'post',
                    data: payload,
                    dataType : 'json',
                    success: function (response) {
                        if (response && response.status == "True" ) {
                            shareComplete();
                        } else {
                            shareComplete();
                        }
                    }
                });
            };

            var shareComplete = function() {
                var btn = document.getElementById( '_willet_want' );
                btn.value = "Wanted!";
                $(btn).attr( 'disabled', "disabled" );
                btn.style.cursor = "default";
            };
    
            // use the selected medium to share about your purchase
            var share = function() {
                var data = {wcode: '{{willt_code}}'};
                // first attempt server-provided token
                if (userFound) {
                    fb_share_handler(data)
                    return;
                } else {
                    FB.login(function(response) {
                            console.log(response);
                            if (!response.authResponse) {
                                // we weren't given permission
                                window.close();
                            } else { 
                                data.fb_token = response.authResponse.accessToken;
                                data.fb_id = response.authResponse.userID;
                                fb_share_handler(data);
                            }
                        }, {
                            scope: 'publish_stream,offline_access,user_about_me,email'
                        }
                    );
                } 
            }; 
            $(document).ready(function() {
                _wait_for_fb();

                userFound = {% if user_found %}true{% else %}false{% endif %};

                $('#_willet_want').click(share);
            });
        </script>
        <link rel="stylesheet" href="/static/buttons/css/{{style}}.css" type="text/css" />
    </head>
    <body>
    
    <input type="button" id="_willet_want" value='{{ want_text }}' />
    
    <div id="fb-root"></div>
  </body>
</html>
