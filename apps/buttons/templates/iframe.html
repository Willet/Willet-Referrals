<!DOCTYPE html>
<html lang='en'>
    <head>
        <!-- Google Analytics -->
        <script type="text/javascript">
            var _gaq = _gaq || [];
            _gaq.push(['_setAccount', 'UA-23764505-9']);
            _gaq.push(['_trackPageview']);
            (function() {
                var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
                ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
            })();
        </script>
        
        <!-- Favicon -->
        <link rel='icon' type='image/vnd.microsoft.icon' href='/static/imgs/favicon.ico' />
        
        <meta http-equiv="X-UA-Compatible" content="IE=8" />
        <meta http-equiv='Content-Type' content='text/html;charset=utf-8' />
        <title>Social Referral</title>
        <link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
        
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js" type="text/javascript"></script>
        <script src="http://connect.facebook.net/en_US/all.js" type="text/javascript"></script> 
        
        <script type="text/javascript">
            
            var share, reset, countChars, willet_conversion, sendGmail, highlight, sendEmailiframeBody,
                shareArea, shareFrame, shareText, charsLeft, clear, shareComplete, fbToken, next;
            var _willet_fb_interval;

            var _wait_for_fb = function() {
                if (typeof window.FB == 'object') {
                    FB.init({ appId: '{{FACEBOOK_APP_ID}}',
                        status: true,
                        cookie: true,
                        xfbml: true,
                        oauth: true
                    });
                } else {
                    console.log('FB not loaded yet');
                    setTimeout('_wait_for_fb()', 100);
                }
            };
            var fb_share_handler = function(payload) {
                var action = '{% firstof app.action "want" %}';
                var obj = '{% firstof app.obj "product" %}';
                console.log(payload)
                $.ajax({
                url: "/b/action/want/product/",
                    type: 'post',
                    data: payload,
                    success: function (response) {
                        if (response && response.status) {
                            shareComplete();
                        } else {
                            console.log("Facebook post failure");
                        }
                    }
                });
            };
    
            // use the selected medium to share about your purchase
            var share = function() {
                var data = {wcode: '{{willt_code}}'};
                // first attempt server-provided token
                if (userFound) {
                    fb_share_handler(data)
                    return;
                } else {
                    FB.login(function(response) {
                            console.log(response);
                            if (!response.authResponse) {
                                // we weren't given permission
                                window.close();
                            } else { 
                                data.fb_token = response.authResponse.accessToken;
                                data.fb_id = response.authResponse.userID;
                                fb_share_handler(data);
                            }
                        }, {
                            scope: 'publish_stream,offline_access,user_about_me,email'
                        }
                    );
                } 
            }; 
            $(document).ready(function() {
                //_willet_fb_interval = setInterval("_wait_for_fb()", 100);
                _wait_for_fb();

                iframeBody = document.getElementById('willt');
                shareFrame = document.getElementById('willt-frame');
                shareArea = document.getElementById('share-area'),
                userFound = {% if user_found %}{{ user_found }}{% else %}false{% endif %};

                $('#_willet_want').click(share);
            });
        </script>
            
        <!-- Blueprint CSS -->
        <link rel="stylesheet" href="/static/css/blueprint/screen.css" type="text/css" media="screen, projection" />
        <link rel="stylesheet" href="/static/css/blueprint/print.css" type="text/css" media="print" />
        <!--[if IE]><link rel="stylesheet" href="blueprint/ie.css" type="text/css" media="screen, projection" /><![endif]-->

        <link rel="stylesheet" href="/static/referral/css/{{style}}.css" type="text/css" />

    </head>
    <body>
    <div id="fb-root"></div>
    <div id="wrapper" height="315px">
        <input type="button" id="_willet_want" value='{% firstof want_text "I want this" %}' />
    </div>
  </body>
</html>
