{% extends "../../plugin/templates/ask.html" %}

{% block styles %}
    <style type="text/css">
        .wrapper { /* overrides ask.css defaults */
            height: auto;
            width: auto;
        }
        #cart_items_display {
            display: block;
            margin: 0 auto;
            padding: 0;
            text-align: center;
        }
        #cart_items_display li {
            border: 1px transparent solid;
            display: inline-block;
            font-size: small;
            margin: 10px 5px;
            padding: 10px;
            width: 200px;
            height: 324px;
            vertical-align: bottom;
        }
        #cart_items_display li:hover {
            border: 1px silver solid;
            border-radius: 5px;
            background-color: #fcfcff;
        }
        #cart_items_display img, #cart_items_display input, #cart_items_display label {
            clear: both;
            display: block;
            margin: 0 auto;
        }
        #cart_items_display input {
            display: none;
        }
        #cart_items_display img {
            max-height: 196px;
            margin-bottom: 12px;
        }
        .dialog_button_area {
            background-color: #f0f0f0;
            padding: 10px;
        }
    </style>
{% endblock styles %}

{% block screens %}
<!---------------------------- Splash Screen ------------------------------>

    <div id="splash">
        <div class="title_bar">
            <img alt="SIBT Logo" src="/static/imgs/sibt_logo_79x50.png" />
            <div>Select items to display in your survey.</div>
        </div>
        <form method="POST" action="">
            <ul id="cart_items_display">
                <!-- JS -->
            </ul>
            <!-- keep here for reference --
             div class="dialog_button_area">
                <input type="hidden" name="app_uuid" value="{{app_uuid}}">
                <input type="hidden" name="user_uuid" value="{{user_uuid}}">
                <input type="hidden" name="instance_uuid" value="{{instance_uuid}}">
                <input type="hidden" name="target_url" value="{{target_url}}">
                
                <input name="postOnWall_btn" id="postOnWall_btn" 
                       type="button" value="Ask friends on Facebook">
                <input name="runFriendPicker_btn" id="runFriendPicker_btn" 
                       type="button" value="Ask friends by email">
            </div -->
        </form>
        <div class="options">
            <div class="option left">
                <div class="button" id="postOnWall" title="Post to your wall">
                    <img alt="friends" src="/static/sibt/imgs/sibt_ask_all.png" />
                    <div class="title">Ask Friends</div>
                    <div class="subtitle">Post to Facebook</div>
                </div>
                <div class="hint">
                    <img alt="hint arrow" src="/static/sibt/imgs/little_arrow.png" />
                    <div>easy &amp; fast</div>
                </div>
            </div>
            <div class="or">or</div>
            <div class="option right">
                <div class="button" id="showChooseScreen" title="Post to your friends' walls">
                    <img alt="friend" src="/static/sibt/imgs/sibt_choose_friends.png" />
                    <div class="title">Choose Friends</div>
                    <div class="subtitle">Get trusted advice</div>
                </div>
                <div class="hint">
                    <img alt="hint arrow" src="/static/sibt/imgs/little_arrow.png" />
                    <div>best advice</div>
                </div>
            </div>
        </div>
    </div>
{% endblock screens %}

{% block js_globals %} {% endblock js_globals %}

{% block ajax_methods %}
    var storeAnalytics = function( evnt ) {
        // do nothing
    };

    var startPartialInstance = function() {
        // do nothing
    };
    
    var sendMessages = function() {
        // do nothing
    };
{% endblock ajax_methods %}

{% block js_functions %} {% endblock js_functions %}

{% block js_init %}
    $(document).ready (function () {
        // controller guarantees there to be > 0 variants
        var _willet_cart_variants = [ {% for variant in variants %}
            {   "id": "{{variant.id}}",
                "title": "{{variant.title}}",
                "image": "{{variant.image}}", // deprecated... try /cart.js.
                "variant_id": "{{variant.variant_id}}",
                "product_uuid": "{{variant.product_uuid}}",
            },
        {% endfor %} ];
        
        var x = null;
        for (x in _willet_cart_variants) {
            // add products onto page.
            $('#cart_items_display').append(
                '<li>' + 
                    '<img class="variant_image" src="' + _willet_cart_variants[x].image + '" />' +
                    '<label>' +
                        '<input name="item' + _willet_cart_variants[x].variant_id + '" ' + 
                               'data-uuid="' + _willet_cart_variants[x].product_uuid + '" ' + 
                               'id="item' + _willet_cart_variants[x].variant_id + '" ' + 
                               'class="variant_select" type="checkbox" checked="checked" />' +
                        _willet_cart_variants[x].title + 
                    '</label>' + 
                '</li>'
            );
        }
        
        // add product selection events onto checkbox.
        $('#cart_items_display li').each (function () {
            $(this).bind('click', function () {
                var checkbox = $(this).find('input')[0];
                checkbox.checked = !checkbox.checked;
                $(this).fadeTo(200, checkbox.checked ? 1.0 : 0.2);
            });
        });
        
        // FROM SIBT
        
        var startPartialInstance = function() {
            var payload = { app_uuid      : "{{app_uuid}}",
                            user_uuid     : "{{user_uuid}}",
                            product_uuids : get_selected_objects (),
                            willt_code    : "{{willt_code}}" };
            $.ajax({
                url      : "{{ URL }}{% url StartPartialWOSIBInstance %}",
                type     : 'post',
                dataType : 'json',
                data     : payload,
                success  : function (tr) {
                    return;
                }
            });
        };
        
        // Open up the FB dialog. Does not do a FB connect with us.
        var postOnWall = function () {
            startPartialInstance ();
            // derp
        };
        $('#postOnWall_btn').click (postOnWall);

        var runFriendPicker = function () {
            // derp
        };
        $('#runFriendPicker_btn').click (runFriendPicker);
        
        var get_selected_objects = function () {
            var uuids = [];
            $('#cart_items_display input').each (function (i, e) {
                var $e = $(e);
                // if ($e.checked) {
                if (e.checked) {
                    uuids.push ($e.data('uuid'));
                }
            });
            console.log(uuids);
            return uuids.join(',');
        }
    });
    showScreen('splash');
{% endblock js_init %}