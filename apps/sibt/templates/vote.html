<!DOCTYPE html>
<html lang='en'>
    <head>
       <!-- Google Analytics -->
        <script type="text/javascript">
            var _gaq = _gaq || [];
            _gaq.push(['_setAccount', 'UA-23764505-9']);
            _gaq.push(['_trackPageview']);
            (function() {
                var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
                ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
            })();
        </script>
        
        <!-- Favicon -->
        <link rel='icon' type='image/vnd.microsoft.icon' href='/static/imgs/favicon.ico' />
        
        <meta http-equiv="X-UA-Compatible" content="IE=8" />
        <meta http-equiv='Content-Type' content='text/html;charset=utf-8' />
        <title>Should I Buy This?</title>
        <link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
        
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js" type="text/javascript"></script>
        <script src="http://connect.facebook.net/en_US/all.js" type="text/javascript"></script> 

        <script type="text/javascript">
            var vote, share, reset,  willet_conversion, sendGmail, highlight, sendEmailiframeBody,
                shareArea, shareFrame, shareText, charsLeft, clear, shareComplete, fbToken, 
                voteComplete, next;
            
            $(document).ready(function() {
                iframeBody = document.getElementById('willt');
                shareFrame = document.getElementById('willt-frame');
                shareArea = document.getElementById('share-area'),
                userFound = {% if user_found %}{{ user_found }}{% else %}false{% endif %};
                shareText = document.getElementById('share-text'),
                charsLeft = document.getElementById('chars-left');

                if (typeof FB != "undefined") {
                    FB.init({ appId: '{{FACEBOOK_APP_ID}}',
                        status: true,
                        cookie: true,
                        xfbml: true,
                        oauth: true
                    });
                } else {
                    console.log('FB not defined');
                }
        
                vote = function( which ) {
                    $.ajax({url: "/s/doVote",
                            type: 'post',
                            data: { instance_uuid : "{{instance.uuid}}",
                                    which : which
                                  },
                            success: function (tr) {
                                if (tr === 'ok') {
                                    voteComplete(('{{is_asker}}' == 'True'));
                                } else {
                                    console.log("Facebook post failure");
                                }
                            }
                        });
                };

                voteComplete = function( is_asker ) {
                    var c   = document.getElementById( 'FOO' );
                    var b   = document.getElementById( 'BAR' );
                    var yes = document.getElementById( 'yesBtn' );
                    var no  = document.getElementById( 'noBtn' );
                    
                    var yesCount = document.getElementById( 'yesCount' );
                    var noCount  = document.getElementById( 'noCount' );
                    var title    = document.getElementById( 'title' );

                    // Turn things Off
                    yes.style.display = "none";
                    no.style.display  = "none";

                    // Turn things On
                    c.style.display         = "inline";
                    b.style.display         = "inline";
                    yesCount.style.display  = "inline";
                    noCount.style.display   = "inline";

                    if( !is_asker ) {
                        title.innerHTML = "Thanks for voting!";
                        title.innerText = "Thanks for voting!";
                    } else {
                        title.innerHTML = "{{asker_name}}, here's what your friends think!";
                        title.innerText = "{{asker_name}}, here's what your friends think!";
                    }
                };

                // clear the share text
                shareComplete = function() {
                    toggleThanks();
                    console.log("Sharing complete!");
                    return true;
                };
            
                clearText = function( elem ) {
                    elem.value = "";
                };
 
                toggleThanks = function () {
                    $("#invite").toggle();
                    $("#thanks").fadeIn(300);
                };
    
                // use the selected medium to share about your purchase
                share = function(medium, uid) {
                    var fb_share_handler = function(payload) {
                        console.log(payload)
                        $.ajax({url: "/fbShare",
                                type: 'post',
                                data: payload,
                                success: function (tr) {
                                    if (tr === 'ok') {
                                        shareComplete();
                                    } else {
                                        console.log("Facebook post failure");
                                    }
                                }
                        });
                    },
                    uid = uid || '';
                    var message = shareText.value.substring(0,141);
                    if (['linkedin', 'twitter', 'fb'].indexOf(medium) !== -1) {
                        // initiate facebook login event if requested
                        if (medium === 'fb') {
                            var fbData = {msg: message, wcode: '{{willt_code}}', img: '{{product_img}}'};
                            // first attempt server-provided token
                            if (userFound) {
                                fb_share_handler(fbData)
                                return;
                            } else {
                                if (typeof FB == 'undefined') {
                                    alert("Sorry Facebook appears to be down for the moment. Please try again in a bit.");
                                    return;
                                }
                                FB.login(function(lr) {
                                        console.log(lr);
                                        if (!lr.authResponse) {
                                            // we weren't given permission
                                            window.close();
                                        } else { 
                                            fbData.fb_token = lr.authResponse.accessToken;
                                            fbData.fb_id = lr.authResponse.userID;
                                            fb_share_handler(fbData);
                                            mixpanelTrack( 'Facebook' );
                                            mixpanelTrack( 'Share' );
                                        }
                                    }, {scope: 'publish_stream,offline_access,user_about_me,email'}
                                );
                    
                            } // if (userFound u
                        } else if (medium === 'twitter'){
                            var OAuthURL = '{{BASE_URL}}/oauth/twitter/login?wuid='
                                            + '&m=' + message + '&wcode={{willt_code}}&img={{product_img}}',
                                            AuthWindow = window.open(OAuthURL, '_blank');
                        } else if (medium === 'linkedin') {
                            console.log('linkedin share', message);
                            var OAuthURL = '{{BASE_URL}}/oauth/linkedin/login?wuid='
                                            + '&m=' + message + '&wcode={{willt_code}}&img={{product_img}}',
                                            AuthWindow = window.open(OAuthURL, '_blank');       
                        } else {
                            // style shareArea according to different social loader
                        }
                        shareArea.style.visibility = 'visible';
                    } else {
                        // social media provider not found
                    }
                };

                // If this is the Asker, show the results.
                {% if is_asker %}
                    voteComplete(('{{is_asker}}' == 'True'));
                {% endif %}
            });
        </script>
        
        <link rel="stylesheet" href="/static/sibt/css/vote.css" type="text/css" />

    </head>
    <body>

    <div id="wrapper">
        <h1 id="title"> Should {{asker_name}} Buy This? </h1>

        <div id="top-div">
            <div id="img-div">
                <img src="{{product_img}}" />
            </div>
            <div id="voting">
                <div id="left-content">
                    <button id="yesBtn" class="button-link" onClick="vote('yes');">Yes</button>
                    <h1 id="yesCount" class="hidden">Yes: <br \> {{yesses}} </h1>
                </div>
                <div id="right-content">
                    <button id="noBtn" class="button-link" onClick="vote('no');">No</button>
                    <h1 id="noCount" class="hidden">No: <br \> {{nos}} </h1>
                </div>
            </div>  
        </div>

        <div id="comments-div">
            <h2 id="BAR" class="hidden">Tell {{asker_name}} Why Your Voted!</h2>
            <script>(function(d, s, id) {
              var js, fjs = d.getElementsByTagName(s)[0];
              if (d.getElementById(id)) {return;}
              js = d.createElement(s); js.id = id;
              js.src = "//connect.facebook.net/en_US/all.js#xfbml=1";
              fjs.parentNode.insertBefore(js, fjs);
            }(document, 'script', 'facebook-jssdk'));</script>
                
            <div id="fb-root"></div>
            <div id="FOO" class="fb-comments hidden" data-href="{{fb_comments_url}}" data-num-posts="5" data-width="575"></div>
        </div>

    </div>
    </body>
</html>
