{% extends "../../plugin/templates/vote.html" %}

{% block styles %}
    <link rel="stylesheet" href="/static/wosib/css/wosib.css" type="text/css" />
{% endblock styles %}

{% block top_screens %}
    {% if wosib_mode %}
        <div id="wosib_select_window">
            <div style="width:400px;float:left;margin:47px 0 0 47px;">
                <div id="selection_box_container">
                    <div id="selection_box"><!-- JS --></div>
                </div>
            </div>
            <div style="width:132px;float:right;margin:96px -1px 0 0px;">
                <button class="continue_to splash">Continue</button>
            </div>
        </div>
        <div id="splash">
            <div class="options">
                <div class="restrictedWidth">
                    <textarea id='shareText' name='shareText' maxlength='1000'>I like both of these items. Which one do you like more?</textarea>
                    <br />
                    <br />
                    <div class="option left">
                        <div class="button" id="postOnWall" title="Post to your wall">
                            <div class="title">Post to Facebook</div>
                            <div class="subtitle">Post to Facebook</div>
                        </div>
                    </div>
                    <div class="or">or</div>
                    <div class="option right">
                        <div class="button" id="showChooseScreen" title="Post to your friends' walls">
                            <div class="title">Choose Friends</div>
                            <div class="subtitle">Get trusted advice</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <div id="splash">
            <div class="content narrow">
                <div class="message" id="message">
                    <textarea id='shareText' name='shareText' maxlength='1000'>I like this - what do you think?</textarea>
                </div>
                <div class="options">
                    <div class="option left">
                        <div class="button" id="postOnWall" title="Post to your wall">
                            <div class="title">Post to Facebook</div>
                            <div class="subtitle">Post to Facebook</div>
                        </div>
                    </div>
                    <div class="or">or</div>
                    <div class="option right">
                        <div class="button" id="showChooseScreen" title="Post to your friends' walls">
                            <div class="title">Choose Friends</div>
                            <div class="subtitle">Get trusted advice</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
{% endblock top_screens %}

{% block js_globals %}
    {% if wosib_mode %}
    {% else %}
        var options = [
            // Could use template here
            {
                title: "Should I buy this?",
                text: "Should I buy this? Let me know!"
            },
            {
                title: "Does anyone own this?",
                text: "I need help!  Does anyone own this? Let me know here:"
            }
        ];
    {% endif %}
{% endblock js_globals %}

{% block ajax_methods %}
    {% if wosib_mode %}
        var storeAnalytics = function( evnt ) {
            _willet.mediator.fire('storeAnalytics', evnt);
        };

        var updateServerUser = function( accessToken, userId ) {
            var payload = { user_uuid: "{{user_uuid}}",
                        accessToken: accessToken,
                        fbUserId: userId
                    };
            $.ajax({
                url: "{{ URL }}{% url UpdateFBAccessToken %}",
                type: 'post',
                dataType: 'json',
                data: payload,
                success: function (tr) {
                    return;
                }
            });

            fbAccessToken = accessToken;
            fbIdentity    = userId;
        };

        // Sends information to server to ask friends & handles response
        var sendMessages = function() {
            var payload, friend_info, asker_info,
                msg   = $("#shareText").val(),
                error = false;

            // Gather up friend info, recording if a friend has an error
            friend_info = getFriendsInfo(); // either null or [...]

            // Gather asker info
            asker_info = asker.getAskerInfo(); // either null or [...]

            if (friend_info && friend_info.length > 0 && asker_info && asker_info.length > 1) {
                // Clean up UI to show loader gif
                showScreen('asking');

                // No errors with friends, submit!
                var payload = {
                    user_name: "{{user_name}}",
                    user_uuid: "{{user_uuid}}",
                    app_uuid: "{{app_uuid}}",
                    product_uuid: "{{product_uuid}}",
                    fb_access_token: fbAccessToken,
                    fb_id: fbIdentity,
                    friends: JSON.stringify(friend_info), // jQuery can't handle complex objects, make it string
                    asker: JSON.stringify(asker_info),
                    products: getSelectedObjects(),  // str
                    msg: msg,
                    default_msg: "Should I buy this? Let me know!",
                    instance_uuid: "{{ instance.uuid }}",  // if not empty, no new instance will be created
                    willt_code: "{{willt_code}}"
                };

                $.ajax({
                    url: "{{ URL }}{% url SendFriendAsks %}",
                    type: 'post',
                    dataType: 'json',
                    data: payload,
                    statusCode: {
                        200: function () {
                            // Success
                            updateEmailAddress();
                            showScreen('success');
                        },
                        400: function (resp, status) {
                            // Bad Request
                            if (resp && resp.data && resp.data.message) {
                                $('.error_message').innerHTML("400 "+resp.data.message);
                            }
                            showScreen('failure');

                        },
                        401: function (resp, status) {
                            // Unauthorized
                            if (resp && resp.data && resp.data.message) {
                                $('.error_message').innerHTML("401 "+resp.data.message);
                            }
                            showScreen('failure');

                        },
                        500: function () {
                            // Internal server error
                            showScreen('failure');
                        }
                    }
                });
            }
        };
    {% else %}
        // Sends analytic data point to server
        var storeAnalytics = function(evnt) {
            _willet.mediator.fire('storeAnalytics', evnt);
        };

        // Sends information to server to ask friends & handles response
        var sendMessages = function() {
            var payload, friend_info, asker_info,
                msg   = $("#shareText").val(),
                error = false;

            // Gather up friend info, recording if a friend has an error
            friend_info = getFriendsInfo(); // either null or [...]

            // Gather asker info
            asker_info = asker.getAskerInfo(); // either null or [...]

            console.log('Asker: '+asker_info+' Friends: '+friend_info+' Error:'+error);

            if (friend_info && friend_info.length > 0 && asker_info && asker_info.length > 1) {
                // Clean up UI to show loader gif
                showScreen('asking');

                // No errors with friends, submit!
                var payload = {
                    user_name: "{{user_name}}",
                    user_uuid: "{{user_uuid}}",
                    app_uuid: "{{app_uuid}}",
                    product_uuid: "{{ product_uuid }}",
                    products: "{{ product_uuid }}",
                    fb_access_token: fbAccessToken,
                    fb_id: fbIdentity,
                    friends: JSON.stringify(friend_info), // jQuery can't handle complex objects, make it string
                    asker: JSON.stringify(asker_info),
                    msg: msg,
                    default_msg: "Should I buy this? Let me know!",
                    instance_uuid: "{{ instance.uuid }}",  // if not empty, no new instance will be created
                    willt_code: "{{willt_code}}"
                };

                $.ajax({
                    url: "{{ URL }}{% url SendFriendAsks %}",
                    type: 'post',
                    dataType: 'json',
                    data: payload,
                    statusCode: {
                        200: function () {
                            // Success
                            updateEmailAddress();
                            showScreen('success');
                        },
                        400: function (resp, status) {
                            // Bad Request
                            if (resp && resp.data && resp.data.message) {
                                $('.error_message').innerHTML("400 "+resp.data.message);
                            }
                            showScreen('failure');

                        },
                        401: function (resp, status) {
                            // Unauthorized
                            if (resp && resp.data && resp.data.message) {
                                $('.error_message').innerHTML("401 "+resp.data.message);
                            }
                            showScreen('failure');

                        },
                        500: function () {
                            // Internal server error
                            showScreen('failure');
                        }
                    }
                });
            }
        };
    {% endif %}
{% endblock ajax_methods %}

{% block js_functions %}

    var resizeProductImage = function (img) {
        var logoWidth = img.width,
            logoHeight = img.height,
            $img = $(img);

        if (logoWidth > 150 || logoHeight > 150) {
            if (logoWidth >= logoHeight){
               $img.height((logoHeight / logoWidth)*150);
               $img.width(150);
            } else {
                $img.height(150);
                $img.width((logoWidth / logoHeight)*150);
            }
        }
    };

    var getSelectedObjects = function () {
        // returns a comma-separated string of product uuids "id,id,id"
        var uuids = [];
        uuids.push($('#selection_box_container>img').prop('alt'));
        uuids.push($('#selection_box>img').prop('alt'));
        return uuids.join(',');
    };

    var updateParentIframeImgSelection = function (src) {
        if (window && window.parent && window.parent.$) {
            var wp$ = window.parent.$;
            wp$('#second_product_src_drop_target').attr('src', src);
        }
    };
{% endblock js_functions %}

{% block js_init %}
    {% if wosib_mode %}
        /*  server guarantees there to be > 0 products;
            if there are 0 products, this script is not loaded at all.
        */
        var cart_products = [ {% for product in products %}
            {   "id": "{{ product.shopify_id }}",
                "title": "{{ product.title }}",
                "image": "{{ product.images.0|default:product.image }}",
                "uuid": "{{ product.uuid }}"
            },
        {% endfor %} {}];
        cart_products.pop(); // remove trailing element... IE7 trailing comma patch

        // deal with the images only if they are there.
        var $selection_box_container = $('#selection_box_container');
        if ($selection_box_container && $selection_box_container.length) {
            var $selection_box = $('#selection_box');
            for (var i = 1; i < cart_products.length; i++) {
                $selection_box
                    .append($('<img />', { // 2nd image onwards are in a dropdown
                        'src': cart_products[i].image,
                        'alt': cart_products[i].uuid
                    }));
            }
            $selection_box_container
                .append($('<img />', { // 1st image is just a tag
                    'src': cart_products[0].image,
                    'alt': cart_products[0].uuid,
                    'css': {
                        'max-width': '120px',
                        'max-height': '120px'
                    }
                }))
                .append($('<img />', {
                    'src': '/static/imgs/or-100.png',
                    'css': {'margin': '0 2px 8px 0'}
                }))
                .append($selection_box);
            $selection_box.imageDropdown({
                'width': '150px',
                'height': '120px',
                'select': updateParentIframeImgSelection
            });
        }

        $('.continue_to.splash').click(function () {
            showScreen('splash');
        });

        showScreen('wosib_select_window');
    {% else %}
        showScreen('splash');
    {% endif %}
{% endblock js_init %}

{% block body_start %}
    {# this is not an empty block #}
{% endblock body_start %}

{% block left_screens %}
    {# this is not an empty block #}
{% endblock left_screens %}

{% block right_screens %}
    {% if wosib_mode %}
        <div id="product_screen" class="wosib center">
            {% for product in products|slice:":2" %}
                {% if forloop.last %}
                    <img alt="or" src="/static/imgs/or-150.png"
                            style="margin: 88px -47px;
                                float: left;
                                line-height: 300px;
                                vertical-align: middle;" />
                {% endif %}
                <div class="product info_launch" data-uuid="{{ product.uuid }}">
                    <!-- thumbnail -->
                    <img alt="product image"
                        src='{{ product.images.0|default:"/static/imgs/noimage-willet.png" }}'
                        {% if forloop.last %}
                        id="second_product_src_drop_target"
                        {% endif %}
                        class="product-image center" />
                    <h2 class="title" style="font-size: 1em">{{ product.title }}</h2>
                    {% if not user_voted %}
                        <button class="button vote"
                                style="position:absolute;bottom:10px;left:34%"
                                data-uuid="{{ product.uuid }}">
                            Vote
                        </button>
                    {% endif %}
                    <div id="success_screen">
                        <h2>Thank you for helping {{ asker.name }}!</h2>
                    </div>
                </div>
                <div id="product_info_{{ product.uuid }}"
                    class="product_info group1" rel="group1">
                    <!-- details -->
                    <div style="float:left; width: 400px;">
                        <a>
                            <img alt="product image"
                                src='{{ product.images.0|default:"/static/imgs/noimage-willet.png" }}'
                                class="product-image center"/>
                        </a>
                        <p style="text-align: center;">
                            {% if not user_voted %}
                                <button class="button vote"
                                        data-uuid="{{ product.uuid }}">
                                    Vote
                                </button>
                            {% endif %}
                        </p>
                    </div>
                    <div style="float:right; width: 400px;">
                        <h2 class="title">{{ product.title }}</h2>
                        {{ product.description|linebreaksbr|striptags }}
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div id="product_screen">
            <h2><a href="{{ product_url }}">{{ product.title|striptags|escape }}</a></h2>
            <img id="product_img" class="slight-highlight product-image" src="{{ product_image|default:"/static/imgs/noimage-willet.png" }}" />
            <div class="description">
                {{ product.description|striptags }}
            </div>
            {% if not user_voted %}
                <div class="choice blob"
                    style="text-align:center; margin: 18px;">
                    <div class="title">
                        Should <b>{{ asker.name }}</b> get this?
                    </div>
                    <div id="success_pending" class="center">
                        <button class="button" id="yes">Yes</button>
                        <button class="button" id="no">No</button>
                    </div>
                    <div id="success_screen">
                        <h2>Thank you for helping {{ asker.name }}!</h2>
                        {% if store_url %}
                            <p style="margin-top:24px;">
                                <a href="{{ store_url }}">Continue Shopping</a>
                            </p>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>
    {% endif %}
{% endblock right_screens %}

{% block body_script %}
    $(document).ready(function () {
        var getDiscount = function () {
            // get the discount code.
            $.ajax({
                url: "{% url DispenseClientDiscountCode %}",
                data: {
                    'client_uuid': "{{ client_uuid }}",
                    'store_url': "{{ store_url }}"
                },
                type: 'post',
                dataType: 'text',
                success: function (data) {
                    if (data) {
                        $("#discount_gettest").show();
                    }
                    $("#discount_code").val(data || "We're out!");
                }
            });
        };

        {% if wosib_mode %}
            {% if not user_voted %}
                var vote = function (ctl) {
                    var product_uuid = $(ctl).data('uuid');
                    if (product_uuid) {
                        var payload = {
                            "user_uuid" : "{{ user_uuid }}",
                            "instance_uuid" : "{{ instance_uuid }}",
                            "product_uuid" : product_uuid
                        };
                        $.ajax({
                            url: "{{ URL }}{% url DoVote %}",
                            type: 'post',
                            data: payload,
                            success: function () {
                                {% if discount_enabled %}
                                    {# discount_enabled is undefined on purpose #}
                                    // discount code thing is temporarily "discouraged"
                                    $(".choice, #product_screen").hide();
                                    $("#discount_screen, #success_message, #why-" + product_uuid + ", #FOO").show();
                                    getDiscount();
                                {% else %}
                                    $("#success_pending").hide();
                                    $("#success_screen").show();
                                {% endif %}
                                $(ctl).text('Voted').attr('disabled', 'disabled');
                            },
                            error: function () {
                                $("#error_message").show();
                            }
                        });
                    }
                };

                $('.vote').click(function (event) {
                    event.stopPropagation();
                    vote(event.target || event.currentTarget);
                });
            {% endif %}

            $('.info_launch').click(function () {
                var iid = '#product_info_' + $(this).data('uuid'),
                    ctl = $(iid);
                $.colorbox({
                    inline: true,
                    fixed: true,
                    href: ctl,
                    rel: 'product_info',
                    'transition': 'fade',
                    'onOpen': function () {
                        ctl.show();
                    },
                    'onClosed': function () {
                        ctl.hide();
                    }
                });
            });


            /*  server guarantees there to be > 0 products;
                if there are 0 products, this script is not loaded at all.
            */
            var cart_products = [ {% for product in products %}
                {   "id": "{{ product.shopify_id }}",
                    "title": "{{ product.title }}",
                    "image": "{{ product.images.0|default:"/static/imgs/noimage-willet.png" }}",
                    "uuid": "{{ product.uuid }}"
                },
            {% endfor %} {}];
            cart_products.pop(); // remove trailing element... IE7 trailing comma patch

            var $selection_box_container = $('#selection_box_container');
            var $selection_box = $('#selection_box');
            for (var i = 1; i < cart_products.length; i++) {
                $selection_box
                    .append($('<img />', { // 2nd image onwards are in a dropdown
                        'src': cart_products[i].image,
                        'alt': cart_products[i].uuid
                    }));
            }
            $selection_box_container
                .append($('<img />', { // 1st image is just a tag
                    'src': cart_products[0].image,
                    'alt': cart_products[0].uuid,
                    'css': {
                        'max-width': '150px',
                        'max-height': '150px'
                    }
                }))
                .append($('<img />', {
                    'src': '/static/imgs/or-150.png'
                }))
                .append($selection_box);
            $selection_box
                .imageDropdown();

            var getSelectedObjects = function () {
                // returns a comma-separated string of product uuids "id,id,id"
                var uuids = [];
                uuids.push($('#selection_box_container>img').prop('alt'));
                uuids.push($('#selection_box>img').prop('alt'));
                return uuids.join(',');
            };

            $('#set_products').click(function () {
                // after creating the instance, allow user to change that products
                // are chosen.
                $.ajax({
                    url: "{% url SaveProductsToInstance %}",
                    data: {
                        'instance_uuid': "{{ instance_uuid }}",
                        'products': getSelectedObjects(),
                        'unshift': '1'
                    },
                    type: 'post',
                    dataType: 'text',
                    success: function () {
                        $('#set_products').text('Saved').attr('disabled', 'disabled');
                    }
                });
            });

            fbinit (document, 'script', 'facebook-jssdk');
        {% else %}
            {% if not user_voted %}
                var vote = function (which) {
                    $.ajax({
                        url: "{% url DoVote %}",
                        type: 'post',
                        data: {
                            instance_uuid : "{{instance.uuid}}",
                            which : which
                        },
                        success: function (tr) {
                            {% if discount_enabled %}
                                {# discount_enabled is undefined on purpose #}
                                $(".choice, #product_screen").hide();
                                $("#discount_screen, #success_message, #success_message h4." + which + ", #FOO").show();
                                // get the discount code.
                                getDiscount();
                            {% else %}
                                $("#success_pending").hide();
                                $("#success_screen").show();
                            {% endif %}
                        },
                        error: function () {
                            $(".choice").hide();
                            $("#error_message").show();
                        }
                    });
                };
                $('.choice button').click(function () {
                    vote(this.id); // click button = vote
                });
            {% endif %}

            fbinit (document, 'script', 'facebook-jssdk');
        {% endif %}
    });
{% endblock body_script %}