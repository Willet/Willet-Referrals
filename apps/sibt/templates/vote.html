<!DOCTYPE html>
<html lang='en'>
    <head>
       <!-- Google Analytics -->
        <script type="text/javascript">
            var _gaq = _gaq || [];
            _gaq.push(['_setAccount', 'UA-23764505-9']);
            _gaq.push(['_trackPageview']);
            (function() {
                var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
                ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
            })();
        </script>
        
        <!-- Favicon -->
        <link rel='icon' type='image/vnd.microsoft.icon' href='/static/imgs/favicon.ico' />
        
        <meta http-equiv="X-UA-Compatible" content="IE=8" />
        <meta http-equiv='Content-Type' content='text/html;charset=utf-8' />
        <title>Should I Buy This?</title>
        <link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
        
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js" type="text/javascript"></script>
        <script src="http://connect.facebook.net/en_US/all.js#xfbml=1" type="text/javascript"></script> 

        <script type="text/javascript">
            var vote, share, reset,  willet_conversion, sendGmail, highlight, sendEmailiframeBody,
                shareArea, shareFrame, shareText, charsLeft, clear, shareComplete, fbToken, 
                voteComplete, next;
            var yesses = {{yesses}};
            var noes = {{noes}};

            var percent_el;

            var calculatePercent = function() {
                var total = yesses + noes; 
                var value = Math.round(parseFloat(yesses/total)*100);
                if (isNaN(value)) {
                    value = 0;
                }
                return value;
            };

            $(document).ready(function() {
                percent_el = $('#result').find('span');
                percent_el.text(calculatePercent());

                iframeBody = document.getElementById('willt');
                shareFrame = document.getElementById('willt-frame');
                shareArea = document.getElementById('share-area'),
                userFound = {% if user_found %}{{ user_found }}{% else %}false{% endif %};
                shareText = document.getElementById('share-text'),
                charsLeft = document.getElementById('chars-left');
                
                /*
                if (typeof FB != "undefined") {
                    FB.init({ appId: '{{FACEBOOK_APP_ID}}',
                        status: true,
                        cookie: true,
                        xfbml: true,
                        oauth: true
                    });
                } else {
                    console.log('FB not defined');
                }
                */
        
                vote = function( which ) {
                    //var count = $('#' + which + 'Count span');
                    //var val = parseInt(count.text()) + 1;
                    //count.text(val);
                    if (which == 'yes') {
                        yesses++;
                    } else {
                        noes++;
                    }
                    percent_el.text(calculatePercent());
                    $.ajax({
                        url: "/s/doVote",
                        type: 'post',
                        data: {
                            instance_uuid : "{{instance.uuid}}",
                            which : which
                        },
                        success: function (tr) {
                            if (tr === 'ok') {
                                // pass
                            } else {
                                console.log("Facebook post failure");
                            }
                        }
                    });
                    $("#BAR span." + which).show();
                    voteComplete(('{{is_asker}}' == 'True'));
                };

                voteComplete = function(is_asker) {
                    var c   = document.getElementById( 'FOO' );
                    var b   = document.getElementById( 'BAR' );
                    //var yes = document.getElementById( 'yesBtn' );
                    //var no  = document.getElementById( 'noBtn' );
                    
                    var yesCount = document.getElementById( 'yesCount' );
                    var noCount  = document.getElementById( 'noCount' );
                    var title    = document.getElementById( 'title' );

                    // Turn things Off
                    //yes.style.display = "none";
                    //no.style.display  = "none";

                    // Turn things On
                    c.style.display         = "inline";
                    b.style.display         = "inline";
                    //yesCount.style.display  = "inline";
                    //noCount.style.display   = "inline";
                    $('#voting').hide(); 
                    $('#result').fadeIn(300);

                    if( !is_asker ) {
                        $(title).html("Thanks for voting!");
                    } else {
                        $(title).html("Here's what your friends think");
                    }
                };

                // clear the share text
                shareComplete = function() {
                    toggleThanks();
                    console.log("Sharing complete!");
                    return true;
                };
            
                clearText = function( elem ) {
                    elem.value = "";
                };
 
                toggleThanks = function () {
                    $("#invite").toggle();
                    $("#thanks").fadeIn(300);
                };
    
                // use the selected medium to share about your purchase
                share = function(medium, uid) {
                    var fb_share_handler = function(payload) {
                        console.log(payload)
                        $.ajax({url: "/fbShare",
                                type: 'post',
                                data: payload,
                                success: function (tr) {
                                    if (tr === 'ok') {
                                        shareComplete();
                                    } else {
                                        console.log("Facebook post failure");
                                    }
                                }
                        });
                    },
                    uid = uid || '';
                    var message = shareText.value.substring(0,141);
                    if (['linkedin', 'twitter', 'fb'].indexOf(medium) !== -1) {
                        // initiate facebook login event if requested
                        if (medium === 'fb') {
                            var fbData = {
                                msg: message, 
                                wcode: '{{willt_code}}', 
                                img: '{{product_img|first}}'};
                            // first attempt server-provided token
                            if (userFound) {
                                fb_share_handler(fbData)
                                return;
                            } else {
                                if (typeof FB == 'undefined') {
                                    alert("Sorry Facebook appears to be down for the moment. Please try again in a bit.");
                                    return;
                                }
                                FB.login(function(lr) {
                                        console.log(lr);
                                        if (!lr.authResponse) {
                                            // we weren't given permission
                                            window.close();
                                        } else { 
                                            fbData.fb_token = lr.authResponse.accessToken;
                                            fbData.fb_id = lr.authResponse.userID;
                                            fb_share_handler(fbData);
                                            mixpanelTrack( 'Facebook' );
                                            mixpanelTrack( 'Share' );
                                        }
                                    }, {scope: 'publish_stream,offline_access,user_about_me,email'}
                                );
                    
                            } // if (userFound u
                        } else if (medium === 'twitter'){
                            var OAuthURL = '{{BASE_URL}}/oauth/twitter/login?wuid='
                                            + '&m=' + message + '&wcode={{willt_code}}&img={{product_img|first}}',
                                            AuthWindow = window.open(OAuthURL, '_blank');
                        } else if (medium === 'linkedin') {
                            console.log('linkedin share', message);
                            var OAuthURL = '{{BASE_URL}}/oauth/linkedin/login?wuid='
                                            + '&m=' + message + '&wcode={{willt_code}}&img={{product_img|first}}',
                                            AuthWindow = window.open(OAuthURL, '_blank');       
                        } else {
                            // style shareArea according to different social loader
                        }
                        shareArea.style.visibility = 'visible';
                    } else {
                        // social media provider not found
                    }
                };

                // If this is the Asker, show the results.
                // {{ has_voted }}
                {% if is_asker or has_voted %}
                    voteComplete(('{{is_asker}}' == 'True'));
                {% endif %}
            });
        </script>
        
        <link rel="stylesheet" href="/static/sibt/css/vote.css" type="text/css" />

    </head>
    <body>

    <div id="wrapper">
        <div id="top-div">
            <div id="img-div">
                <img src="{{ product_img|first }}" />
            </div>
            <div id="top-right">
                <div id="asker_title">
                    {% if asker_pic %}
                        <img align="left" src="{{ asker_pic }}"  />
                    {% endif %}
                    <div>
                        <span>{{asker_name}}</span>   
                        <p id="title">
                            Should I Buy This?
                        </p>
                    </div>
                </div>
                
                <div id="voting">
                    <div id="left-content">
                        <button id="yesBtn" class="button-link yes" onClick="vote('yes');">
                            Buy it
                        </button>
                    </div>
                    <div id="right-content">
                        <button id="noBtn" class="button-link no" onClick="vote('no');">
                            Skip it
                        </button>
                    </div>
                </div>  
                <div id="result" style="display: none">
                    <h1><span></span>%</h1>
                    say buy it!
                </div>
            </div>
        </div>

        <div id="comments-div">
            <h2 id="BAR" class="hidden">
                <span class="yes">
                    Tell {{asker_name}} why you voted YES. 
                </span>
                <span class="no">
                    Tell {{asker_name}} why you voted NO. 
                </span>
            </h2>
            <script>
                window.fbAsyncInit = function() {
                    FB.init({
                        appId: '{{FACEBOOK_APP_ID}}', // App ID
                        //channelURL : '//WWW.YOUR_DOMAIN.COM/channel.html', // Channel File
                        status: true, // check login status
                        cookie: true, // enable cookies to allow the server to access the session
                        oauth: true, // enable OAuth 2.0
                        xfbml: true  // parse XFBML
                    });
                };

                (function(d, s, id) {
                    var js, fjs = d.getElementsByTagName(s)[0];
                    if (d.getElementById(id)) {return;}
                    js = d.createElement(s);
                    js.id = id;
                    js.async = true;
                    js.src = "//connect.facebook.net/en_US/all.js#xfbml=1";
                    fjs.parentNode.insertBefore(js, fjs);
                }(document, 'script', 'facebook-jssdk'));
            </script>
                
            <div id="fb-root"></div>
            <div id="FOO" class="fb-comments hidden" data-href="{{fb_comments_url}}" data-num-posts="5" data-width="575"></div>
        </div>
        <div id="share_again">
            <p>
                Invite a friend to vote: <input style="width: 250px" type="text" readonly="readonly" value="{{ share_url }}" />
            </p>
        </div>

    </div>
    </body>
</html>
