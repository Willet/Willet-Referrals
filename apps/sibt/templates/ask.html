<!DOCTYPE html>
<html lang='en'>
    <head>
       <!-- Google Analytics -->
        <script type="text/javascript">
            var _gaq = _gaq || [];
            _gaq.push(['_setAccount', 'UA-23764505-9']);
            _gaq.push(['_trackPageview']);
            (function() {
                var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
                ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
            })();
        </script>
        
        <!-- Favicon -->
        <link rel='icon' type='image/vnd.microsoft.icon' href='/static/imgs/favicon.ico' />
        
        <meta http-equiv="X-UA-Compatible" content="IE=8" />
        <meta http-equiv='Content-Type' content='text/html;charset=utf-8' />
        <title>Should I Buy This?</title>
        <link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
        
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js" type="text/javascript"></script>
        <script src="http://connect.facebook.net/en_US/all.js" type="text/javascript"></script> 

        <script type="text/javascript">
            var willet_conversion, fbToken, next, highlight, 
                sendEmailiframeBody, shareArea, shareFrame, shareText, 
                charsLeft, clear; 
            var productDesc = "{{ productDesc|striptags }}";
            var fbData = {
                msg: '', 
                img: '{{ productImg|first }}', 
                name: '{{ productName }}',
                desc: productDesc,
                app_uuid: '{{ app.uuid }}',
                willt_code: '{{ willt_code }}',
                product_img: '{{ productImg|first }}'
            };
            var _willet_check_scripts = function() {
                if (typeof FB != 'undefined') {
                    // facebook is loaded
                    _willet_run();
                } else {
                    window.setTimeout(_willet_check_scripts, 100);
                }
            };

            var share = function(medium, uid) {
                // use the selected medium to share about your purchase
                var uid = uid || '';
                var message = shareText.value.substring(0,141);
                // initiate facebook login event if requested
                if (medium === 'fb') {
                    fbData.msg = message; 
                    if (userFound) {
                        fb_share_handler(fbData)
                        return;
                    } else {
                        fb_login_and_share();
                        return;
                    } // if (userFound u
                } else if (medium === 'twitter'){
                    var OAuthURL = '{{BASE_URL}}/oauth/twitter/login?wuid=' +
                                    '&m=' + message + 
                                    '&wcode={{willt_code}}' + 
                                    '&img={{productImg|first}}' + 
                                    '&name={{productName}}' + 
                                    '&desc={{productDesc|striptags}}';
                    var AuthWindow = window.open(OAuthURL, '_blank');
                } 
                shareArea.style.visibility = 'visible';
            };

            var fb_share_handler = function(payload) {
                console.log(payload);
                $.ajax({
                    url: '{% url ShareSIBTInstanceOnFacebook %}',
                    type: 'post',
                    dataType: 'json',
                    data: payload,
                    success: function (response) {
                        if (response.success) {
                            shareComplete('facebook');
                        } else {
                            if (userFound) {
                                // we tried to use an existing user
                                // but the share failed!
                                userFound = false; // dont do this twice
                                fb_login_and_share();
                            }
                            console.log("Facebook post failure", response);
                        }
                    }
                });
            };

            var twitterCallback = function() {
                /**
                 * called after successful share on twitter
                 */
                $.ajax({
                    url: "{% url StartSIBTInstance %}",
                    type: 'post',
                    dataType: 'json',
                    data: {
                        app_uuid: "{{app.uuid}}",
                        willt_code: "{{willt_code}}",
                        product_img : "{{productImg|first}}" },
                    success: function (tr) {
                        shareComplete('twitter');
                        console.log(tr);
                    }
                }); 
            };

            var fb_login_and_share = function() {
                // tries to auth with facebook 
                FB.login(function(lr) {
                        console.log(lr);
                        if (!lr.authResponse) {
                            // we weren't given permission
                            window.close();
                        } else { 
                            // TODO: need to support new authresponse
                            fbData.fb_token = lr.authResponse.accessToken;
                            fbData.fb_id = lr.authResponse.userID;
                            fb_share_handler(fbData);
                            //mixpanelTrack('Facebook');
                            //mixpanelTrack('Share');
                        }
                    }, {scope: 'publish_stream,offline_access,user_about_me,email'}
                );
            };

            var shareComplete = function(medium) {
                // Sharing is complete (either twitter or facebook)
                $("#invite").hide();
                if (medium == 'twitter') {
                    // ask for their email
                    $("#thanks").fadeIn(300);
                } else {
                    // we will have the facebook email
                    // so dont ask for it
                    $('#thanks_facebook').fadeIn(300);
                }

                var target = parent.postMessage ? parent : (parent.document.postMessage ? parent.document : undefined);
                target.postMessage(
                    'shared',
                    '*'
                );
                console.log("Sharing complete!");

                return true;
            };

            var toggleThanks = function () {
                $("#invite").toggle();
                $("#thanks").fadeIn(300);
                parent._willet_ask_success = true;
            };

            var countChars = function() {
                var count = 140 - shareText.value.length;
                charsLeft.innerHTML = count + " characters left";
                if (count < 0){
                    $('#twitter_button')
                    .addClass('disabled')
                    .attr('onclick', '');
                } else {
                    $('#twitter_button')
                    .removeClass('disabled')
                    .attr('onclick', 'share("twitter");');
                }
            };

            var updateEmailAddress = function() {
                var addr = document.getElementById( 'email-field' ).value;
                    
                $.ajax({
                    url: "/updateEmailAddress",
                    type: 'post',
                    data: { email : addr },
                    success: function (tr) {
                        document.getElementById('email-field').style.display = 'none';
                        document.getElementById('email-btn').style.display = 'none';
                        document.getElementById('email-conf').style.display = 'inline';
                    }
                });
            };
    
            var reset = function() { 
                iframeBody.style.visibility = 'visible';
                shareArea.style.visibility = 'hidden';
                shareFrame.src = '';
            };
    
            var toggleDefaultValue = function(el, onoff) {
                if (onoff) {
                    var defaultvalue = el.siblings('.defaultValue').html();
                    el.css('color', '#777').val(defaultvalue);
                } else {
                    el.css('color', '#444').val('');
                }
            }; // end function
            
            /**
             * ACTUAL PAGE LOGIC
             */
            var _willet_run = function() {
                // fb is loaded, run our scripts
                iframeBody = document.getElementById('willt');
                shareFrame = document.getElementById('willt-frame');
                shareArea = document.getElementById('share-area'),
                userFound = {% if user_found %}{{ user_found }}{% else %}false{% endif %};
                shareText = document.getElementById('share-text'),
                charsLeft = document.getElementById('chars-left');

                if (FB != 'undefined') {
                    FB.init({ appId: '{{FACEBOOK_APP_ID}}',
                        status: true,
                        cookie: true,
                        xfbml: true,
                        oauth: true
                    });
                } else {
                    console.log("Facebook not ready!");    
                }
            
                // Controls default values of input & textarea elements
                $('.defaultValue').siblings('input, textarea').focus(
                    function () {
                        var el = $(this),
                            defaultValue = el.siblings('.defaultValue').html();
                        if (el.val() === defaultValue) {
                            toggleDefaultValue(el, false);
                        }
                    }
                ).blur(
                    function () { 
                        var el = $(this);
                        if (el.val() === '' ) {
                            toggleDefaultValue(el, true);
                        }
                    }
                ).each(
                    function () { 
                        var el = $(this);
                        if (el.val() === '') {
                            toggleDefaultValue(el, true); 
                        }
                    }
                );
            
                countChars();
            };

            $(document).ready(function() {
                _willet_check_scripts();
            });
        </script>
        
        <link rel="stylesheet" href="/static/sibt/css/shopify.css" type="text/css" />

    </head>
    <body>

    <div id="fb-root"></div>
    <div id="wrapper">
        <div id="invite" class="willt">
            
            <div id="top-div" width="100%">
                <div id="product-img">
                    <img src="{{productImg|first}}" />
                </div>

                <div id="text-div">
                    <div class="" id="chars-left">140 characters left</div>

                    <textarea wrap="soft" id="share-text" onupdate="countChars();" onkeydown="countChars();" onkeyup="countChars();">I'm not sure if I should buy this. Help me out by voting here: {{willt_url}}</textarea>
                </div>
            </div>

            <div width="100%" id="buttons">
                <div class="prepend-top button-link" title="Share on Facebook" onclick="share('fb');">
                    <img src="/static/imgs/fb-logo.png" width="20px" height="20px" />
                    Share on Facebook
                </div>
                <div id="twitter_button" class='button-link' title="Tweet on Twitter" onclick="share('twitter');">
                    <img src="/static/imgs/twitter-logo.png" width="20px" height="20px" />
                    Tweet on Twitter
                </div>
            </div>
        </div>

        <div id="thanks" class="willt hidden">
            <h1 style="margin-top: 1.5em">Asking your friends ...</h1>

            <div id="email-wrapper">
                <p>
                    Enter your e-mail address so we can<br /> notify you when your the feedback:
                </p>
                
                <input id="email-field" type="text"> </input>
                <button id="email-btn" onClick="updateEmailAddress();">Submit</button>
                <p id="email-conf" style="display:none">Thanks! We'll be in touch!</p>
            </div>
        </div>

        <div id="thanks_facebook" class="willt hidden">
            <h1 style="margin-top: 2.5em">Asking your friends...</h1>
            <p>
                We will contact you as soon as your friends vote!
            </p>
        </div>

        <div id="tweet-complete" onclick="twitterCallback();"></div>
        <div id="share-area">
            <iframe id="willt-frame" class="hidden"></iframe>
        </div>
    </div>
    </body>
</html>
