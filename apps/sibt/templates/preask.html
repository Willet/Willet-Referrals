<!DOCTYPE html>
<html lang='en'>
    <head>
       <!-- Google Analytics -->
        <script type="text/javascript">
            var _gaq = _gaq || [];
            _gaq.push(['_setAccount', 'UA-23764505-9']);
            _gaq.push(['_trackPageview']);
            (function() {
                var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
                ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
            })();
        </script>
        
        <!-- Favicon -->
        <link rel='icon' type='image/vnd.microsoft.icon' href='/static/imgs/favicon.ico' />
        
        <meta http-equiv="X-UA-Compatible" content="IE=8" />
        <meta http-equiv='Content-Type' content='text/html;charset=utf-8' />
        <title>Should I Buy This?</title>
        <link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
        
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js" type="text/javascript"></script>

        <script type="text/javascript">
            var willet_conversion, fbToken, next, highlight, 
                sendEmailiframeBody, shareArea, shareFrame, shareText, 
                charsLeft, clear, storeAnalytics;
            var message,
                motivation_text; 
            var userFound  = {% if user_found %}{{ user_found }}{% else %}false{% endif %};
            var fbData = {
                msg: '', 
                img: '{{ productImg|first }}', 
                name: '{{ productName|escape }}',
                product_id: '{{ product_id }}',
                app_uuid: '{{ app.uuid }}',
                willt_code: '{{ willt_code }}',
                product_img: '{{ productImg|first }}',
                user_uuid: '{{ user.uuid }}',
                motivation: ''
            };

            var storeAnalytics = function( evnt ) {
                $.ajax({
                    //url: "{{URL}}/s/storeAnalytics?evnt="+ evnt +
                    url: "{{ URL }}{% url TrackSIBTUserAction %}",
                    data: {
                        what: evnt,
                        instance_uuid: '',
                        app_uuid: '{{ app.uuid }}',
                        user_uuid: '{{ user.uuid }}',
                        target_url: '{{ target_url }}'
                    }, type: 'get',
                    success: function (response) {
                        return;
                    }
                });
            };

            var share = function() {
                storeAnalytics('SIBTAskUserClickedShare');
                $('#motivation').hide();
                $("#invite").hide();
                $("#loading").fadeIn();

                var el = $('#share-text')[0];
                //if (el.tagName != "TEXTAREA") {
                //    var mtext = $('#m_text');
                    //motivation_text = mtext.val();
                    //mtext.replaceWith(motivation_text);
                //    message = $(el).text();
                //} else {
                    message = $(el).val();
                //}

                fbData.msg = message; 
                fbData.motivation = motivation_text;
                //if (userFound) {
                //    fb_share_handler(fbData)
                //    return;
                //} else {
                    FB.login(function(lr) {
                            if (!lr.authResponse) {
                                // we weren't given permission
                                storeAnalytics('SIBTFBConnectCancelled');
                                doPostMessage('close');
                                window.close();
                            } else { 
                                // TODO: need to support new authresponse
                                fbData.fb_token = lr.authResponse.accessToken;
                                fbData.fb_id = lr.authResponse.userID;
                                fb_share_handler(fbData);
                            }
                        }, {scope: 'publish_stream,offline_access,user_about_me,email'}
                    );
                    return;
                //} // if (userFound u
                shareArea.style.visibility = 'visible';
            };

            var fb_share_handler = function(payload) {
                $.ajax({
                    url: '{% url ShareSIBTInstanceOnFacebook %}',
                    type: 'post',
                    dataType: 'json',
                    data: payload,
                    success: function (response) {
                        console.log('got response', response);
                        if (response.success) {
                            shareComplete('facebook');
                        } else {
                            if (userFound) {
                                // we tried to use an existing user
                                // but the share failed!
                                userFound = false; // dont do this twice
                                fb_login_and_share();
                            } else {
                                console.log("Facebook post failure", response);
                                $("#loading").hide();
                                $("#error").fadeIn(300);
                            }
                        }
                    }
                });
            };

            var twitterCallback = function() {
                /**
                 * called after successful share on twitter
                 */
                $.ajax({
                    url: "{% url StartSIBTInstance %}",
                    type: 'post',
                    dataType: 'json',
                    data: {
                        app_uuid: "{{app.uuid}}",
                        willt_code: "{{willt_code}}",
                        product_img : "{{productImg|first}}" },
                    success: function (tr) {
                        shareComplete('twitter');
                        //console.log(tr);
                    }
                }); 
            };

            var fb_login_and_share = function() {
                // tries to auth with facebook 
                FB.login(function(lr) {
                        if (!lr.authResponse) {
                            // we weren't given permission
                            storeAnalytics('SIBTFBConnectCancelled');
                            doPostMessage('close');
                            window.close();
                        } else { 
                            // TODO: need to support new authresponse
                            fbData.fb_token = lr.authResponse.accessToken;
                            fbData.fb_id = lr.authResponse.userID;
                            fb_share_handler(fbData);
                        }
                    }, {scope: 'publish_stream,offline_access,user_about_me,email'}
                );
            };

            var shareComplete = function(medium) {
                // Sharing is complete (either twitter or facebook)
                $("#invite").hide();
                $("#loading").hide();
                if (medium == 'twitter') {
                    // ask for their email
                    $("#thanks").fadeIn(300);
                } else {
                    // we will have the facebook email
                    // so dont ask for it
                    $('#thanks_facebook').fadeIn(300);
                }
                doPostMessage('shared');
                //console.log("Sharing complete!");

                return true;
            };
            
            var doPostMessage = function(message) {
                var target = parent.postMessage ? parent : (parent.document.postMessage ? parent.document : undefined);
                target.postMessage(
                    message,
                    '*'
                );
            };

            var toggleThanks = function () {
                $("#invite").toggle();
                $("#thanks").fadeIn(300);
                parent._willet_ask_success = true;
            };

            var updateEmailAddress = function() {
                var addr = document.getElementById( 'email-field' ).value;
                    
                $.ajax({
                    url: "/updateEmailAddress",
                    type: 'post',
                    data: { email : addr },
                    success: function (tr) {
                        document.getElementById('email-field').style.display = 'none';
                        document.getElementById('email-btn').style.display = 'none';
                        document.getElementById('email-conf').style.display = 'inline';
                    }
                });
            };
    
            var reset = function() { 
                iframeBody.style.visibility = 'visible';
                shareArea.style.visibility = 'hidden';
                shareFrame.src = '';
            };
    
            var toggleDefaultValue = function(el, set_default) {
                if (set_default) {
                    var value = el.siblings('.defaultValue').val();
                    el.addClass('default');
                    el.val(value);
                    //console.log('setting default value', value);
                } else {
                    el.removeClass('default');
                    el.val('');
                    //console.log('removing default, clearing val');
                }
            }; // end function

            var done_motivation = function () {
                // go to next!
                $('#motivation').hide();
                //$('#invite').fadeIn('fast');
                share('fb');
            };
            
            $(document).ready(function() {
                // fb is loaded, run our scripts
                iframeBody = document.getElementById('willt');
                shareFrame = document.getElementById('willt-frame');
                shareArea  = document.getElementById('share-area'),
                shareText  = document.getElementById('share-text'),
                charsLeft  = document.getElementById('chars-left');

                // the share on facebook buttonn
                //$('#share-button').click(share);

                $('#cancel-button').click(function() {
                    storeAnalytics('SIBTAskUserClosedIframe');
                    doPostMessage('close');
                });
                $('.close-button').click(function() {
                    doPostMessage('close');
                });

                
                /*
                // random default values
                var default_values = [
                    'ex: for prom',
                    'ex: for work',
                    'ex: as a gift'
                ];
                var randomnumber = Math.floor(Math.random() * default_values.length);
                $('#share-text input.defaultValue').val(default_values[randomnumber]);

                // Controls default values of input & textarea elements
                $('.defaultValue').siblings('input, textarea').focus(function () {
                    var el = $(this),
                        defaultValue = el.siblings('.defaultValue').val();
                    if (el.val() === defaultValue) {
                        toggleDefaultValue(el, false);
                    }
                }).blur(function () { 
                    var el = $(this);
                    if (el.val() === '' ) {
                        toggleDefaultValue(el, true);
                    }
                }).each(function () { 
                    var el = $(this);
                    if (el.val() === '') {
                        toggleDefaultValue(el, true); 
                    }
                });
                */
            });
        </script>
        
        <link rel="stylesheet" href="/static/sibt/css/shopify.css" type="text/css" />

        <style>
            @font-face {
                 font-family: fb_font;
                 src: url("/static/fonts/KlavikaBold.otf") 
            }
            html, body {
                background-color: white;
                color: #383f41;
            }
            button {
                background: rgb(186,209,226); /* Old browsers */

                /* IE9 SVG, needs conditional override of 'filter' to 'none' */

                background: url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/Pgo8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgdmlld0JveD0iMCAwIDEgMSIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSI+CiAgPGxpbmVhckdyYWRpZW50IGlkPSJncmFkLXVjZ2ctZ2VuZXJhdGVkIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjAlIiB5MT0iMCUiIHgyPSIwJSIgeTI9IjEwMCUiPgogICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iI2JhZDFlMiIgc3RvcC1vcGFjaXR5PSIxIi8+CiAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiMzYjU5OTciIHN0b3Atb3BhY2l0eT0iMSIvPgogIDwvbGluZWFyR3JhZGllbnQ+CiAgPHJlY3QgeD0iMCIgeT0iMCIgd2lkdGg9IjEiIGhlaWdodD0iMSIgZmlsbD0idXJsKCNncmFkLXVjZ2ctZ2VuZXJhdGVkKSIgLz4KPC9zdmc+);

                background: -moz-linear-gradient(top,  rgba(186,209,226,1) 0%, rgba(59,89,151,1) 100%); /* FF3.6+ */

                background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,rgba(186,209,226,1)), color-stop(100%,rgba(59,89,151,1))); /* Chrome,Safari4+ */

                background: -webkit-linear-gradient(top,  rgba(186,209,226,1) 0%,rgba(59,89,151,1) 100%); /* Chrome10+,Safari5.1+ */

                background: -o-linear-gradient(top,  rgba(186,209,226,1) 0%,rgba(59,89,151,1) 100%); /* Opera 11.10+ */

                background: -ms-linear-gradient(top,  rgba(186,209,226,1) 0%,rgba(59,89,151,1) 100%); /* IE10+ */

                background: linear-gradient(top,  rgba(186,209,226,1) 0%,rgba(59,89,151,1) 100%); /* W3C */

                filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#bad1e2', endColorstr='#3b5997',GradientType=0 ); /* IE6-8 */

                color: white;
                font-family: fb_font;
                font-size: 16px;
                font-weight: bold;

                border: 1px solid #1C4596;
                border-radius: 5px;

                padding: 5px;
                margin: 35px 10px 10px 10px;
            }
            button .fb {
                font-family: fb_font;
                font-size: 40px;
                padding: 0px 8px 0px 0px;
                margin: 6px 0px 0px 0px;
                float: left;
                border-right: 1px solid #1C4596;
            }
            button p {
                float: left;
                margin: 15px 0px 0px 10px;
                padding: 0px;
            }
            #title_bar {
                width: 100%;
                height: 55px;
            }
            #title_bar img {
                float: left;
                height: 50px;
                margin: 0px 0px 0px 6px;
                padding: 0px;
            }
            #title_bar h2 {
                padding: 0px;
                margin: 0px;

                font-size: 25px;
                margin: 0px;
                padding: 10px;
            }
            #title_bar p {
                font-size: 10px;
                padding: 0px;
                margin: -10px 0px 0px 94px;
            }
            #fb_btns {
                height: 124px;

                background-color: #e9f0f0;
                color: #616262;
                border-top: 1px solid #616262;
                border-bottom: 1px solid #616262;
            }
            #willet {
                width: 100%;
                height: 35px;
            }
            #willet p {
                float: right;
                font-size: 10px;
            }
            #willet img {
                float: right;
                height: 20px;
                margin: 5px 10px 5px 3px;
            }
        </style>
    </head>
    <body>
    <div id="wrapper">
        <div id="title_bar">
            <img src="/static/imgs/sibt_logo.png" />
            <h2>Should You Buy This?</h2>
            <p>The fastest way to get shopping advice from friends & family</p>
        </div>

        <div id="fb_btns">
            <button title="Post to your wall" value="Ask All Friends">
                <p class="fb">f</p>
                <p>Ask All<br />Friends</p>
            </button>
            <button title="Post to your friends' walls" value="Choose Your Friends">
                <p class="fb">f</p>
                <p>Choose Which<br />Friends</p>
            </button>
        </div>

        <div id="willet">
            <a href="http://www.willetinc"><img src="/static/imgs/logo.png" /></a>
            <p>Powered by</p>
        </div>
    </div>

    <div id="fb-root"></div>
    <script>
        window.fbAsyncInit = function() {
            // see: http://stackoverflow.com/questions/7655352/facebook-comment-fbcomment-returning-https-content-when-called-over-http
            //FB._https = true;
            FB.init({
                appId: '{{FACEBOOK_APP_ID}}', // App ID
                //channelURL : '//WWW.YOUR_DOMAIN.COM/channel.html', // Channel File
                status: true, // check login status
                cookie: true, // enable cookies to allow the server to access the session
                oauth: true, // enable OAuth 2.0
                xfbml: true  // parse XFBML
            });
        };

        (function(d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) {return;}
            js = d.createElement(s);
            js.id = id;
            js.async = true;
            js.src = "https://connect.facebook.net/en_US/all.js#xfbml=1";
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));
    </script>
</body>
</html>

