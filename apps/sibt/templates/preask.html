<!DOCTYPE html>
<html lang='en'>
    <head>
       <!-- Google Analytics -->
        <script type="text/javascript">
            var _gaq = _gaq || [];
            _gaq.push(['_setAccount', 'UA-23764505-9']);
            _gaq.push(['_trackPageview']);
            (function() {
                var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
                ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
            })();
        </script>
        
        <!-- Favicon -->
        <link rel='icon' type='image/vnd.microsoft.icon' href='/static/imgs/favicon.ico' />
        
        <meta http-equiv="X-UA-Compatible" content="IE=8" />
        <meta http-equiv='Content-Type' content='text/html;charset=utf-8' />
        <title>Should I Buy This?</title>
        <link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
        
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js" type="text/javascript"></script>
        <script src="/static/js/jquery-ui-1.8.16.custom.min.js" type="text/javascript"></script>
        <script src="/static/js/jquery.ui.autocomplete.html.js" type="text/javascript"></script>

        <script type="text/javascript">
            var userFound  = {% if user_found %}{{ user_found }}{% else %}false{% endif %};
            var friends = [];
            var friendNames = [];
            var selectionCount = 0;

            function createFriend(fb_id, name) {
                this.fb_id = fb_id;
                this.name  = name;
            };

            var storeAnalytics = function( evnt ) {
                $.ajax({
                    url: "{{ URL }}{% url TrackSIBTUserAction %}",
                    data: {
                        what: evnt,
                        instance_uuid: '',
                        app_uuid   : '{{ app_uuid }}',
                        user_uuid  : '{{ user_uuid }}',
                        target_url : '{{ target_url }}'
                    }, type: 'get',
                    success: function (response) {
                        return;
                    }
                });
            };

            var doPostMessage = function(message) {
                var target = parent.postMessage ? parent : (parent.document.postMessage ? parent.document : undefined);
                target.postMessage(
                    message,
                    '*'
                );
            };

            var postOnWall = function () {
                startPartialInstance();
                storeAnalytics('SIBTNoConnectFBDialog');

                FB.ui({ method:  'feed',
                        display: 'popup',
                        link:    '{{share_url}}',
                        picture: '{{product_images|first}}',
                        name:    "{{product_title|escape}}",
                        caption: '{{store_domain}}',
                        description: "{{ product_desc|striptags|escape }}",
                        redirect_uri: '{{fb_redirect}}' });
                
                doPostMessage('close');
            };

            var chooseFriends = function () {
                // If the user hasn't connected with us,
                if ( !userFound ) {
                    $("#fb_btns").html( '<h3>Login to Facebook<br />so you can select your friends!</h3>' );

                   FB.login(function(response) {
                            if (!response.authResponse) {
                                // we weren't given permission
                                storeAnalytics('SIBTFBConnectCancelled');
                                doPostMessage('close');
                                window.close();
                            } else { 
                                FBConnectHandler( response.authResponse );
                            }
                        }, {scope: 'publish_stream,offline_access,user_about_me,email'}
                    );
                } else {
                    // Redirect to friend picker
                
                    FB.api( '/me/friends', function(response) {
                        alert( response );
                    });


                    
                
                }
            };

            var updateServerUser = function( accessToken, userId ) {
                payload = { user_uuid   : "{{user_uuid}}",
                            accessToken : accessToken,
                            fbUserId    : userId };
                $.ajax({
                    url: "{{ URL }}{% url StartPartialSIBTInstance %}",
                    type: 'post',
                    dataType: 'json',
                    data: payload,
                    success: function (tr) {
                        return;
                    }
                });
            };

            var FBConnectHandler = function (authResponse) {
                $("#splash").hide();
                $("#friendPicker").show();

                // Store FB data in the server.
                updateServerUser( authResponse.accessToken, authResponse.userID );

                FB.api( '/me/friends', function(response) {
                    friends = response.data;
                    friends.sort();

                    $.each( response.data, function( i ) { friendNames.push( friends[i].name ); } );
                    
                    $( "#tags" ).autocomplete({
                        source: friendNames,
                        select: friendSelectedByAutocomplete,
                        close:  clearNameEntry
                    });  
                });

            };

            var clearNameEntry = function() {
                $("#tags").attr( 'value', '' );
            };

            var friendSelectedByAutocomplete = function( event, ui ) {
                // ui.item is friend
                
                var i = friendNames.indexOf( ui.item.value );
                selectFriend( ui.item.value, friends[i].id );

                // Clean up UI
                var p = $("#chosenFriends p");
                if ( p.length != 0 ) {
                    p.remove();
                }
            };

            var selectFriend = function ( name, fb_id ) {
                if ( $('#check' + fb_id).length == 0 ) {
                    var div = $(document.createElement( 'input' ));
                    div.attr( 'id', 'check' + fb_id );
                    div.attr( 'type', 'checkbox' );
                    div.attr( 'value', fb_id );
                    div.attr( 'name', name );
                    div.attr( 'checked', 'checked' );
                    div.hide();
                    $("body").append(div);
                    
                    var tmp = $(document.createElement( 'img' ));
                    tmp.attr( 'src', 'http://graph.facebook.com/' + fb_id + '/picture' );
                    tmp.attr( 'id', 'img' + fb_id );
                    tmp.attr( 'style', 'width:52px; height:52px;' );
                    tmp.attr( 'onclick', 'friendClick(this)' );
                    $('#chosenFriends').append( tmp );

                    selectionCount += 1;
                    
                    $("#selectionCount").html( "Selected: " + selectionCount );
                }
            };

            var deselectFriend = function ( fb_id ) {
                $('#check' + fb_id ).remove();
                $('#img' + fb_id ).remove();

                selectionCount -= 1;
                $("#selectionCount").html( "Selected: " + selectionCount );
            };

            var friendClick = function( elem ) {
                var id = $(elem).attr( 'id' );
                deselectFriend( id.substring( 3 ) );
            };
    
            var startPartialInstance = function() {
                $.ajax({
                    url: "{{ URL }}{% url StartPartialSIBTInstance %}?" + 
                            "&app_uuid={{app_uuid}}" +
                            "&user_uuid={{user_uuid}}" +
                            "&product_uuid={{product_uuid}}" +
                            "&willt_code={{willt_code}}",
                    type: 'get',
                    success: function (tr) {
                    }
                });
            };
            
            $(document).ready(function() {
                $('#cancel-btn').click(function() {
                    storeAnalytics('SIBTAskUserClosedIframe');
                    doPostMessage('close');
                });

                      
        });
        </script>
        
        <link rel="stylesheet" href="/static/sibt/css/shopify.css" type="text/css" />

        <style>
            @font-face {
                 font-family: fb_font;
                 src: url("/static/fonts/KlavikaBold.otf") 
            }
            html, body {
                background-color: white;
                color: #383f41;
            }
            button {
                background: rgb(186,209,226); /* Old browsers */
                /* IE9 SVG, needs conditional override of 'filter' to 'none' */
                background: url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/Pgo8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgdmlld0JveD0iMCAwIDEgMSIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSI+CiAgPGxpbmVhckdyYWRpZW50IGlkPSJncmFkLXVjZ2ctZ2VuZXJhdGVkIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjAlIiB5MT0iMCUiIHgyPSIwJSIgeTI9IjEwMCUiPgogICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iI2JhZDFlMiIgc3RvcC1vcGFjaXR5PSIxIi8+CiAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiMzYjU5OTciIHN0b3Atb3BhY2l0eT0iMSIvPgogIDwvbGluZWFyR3JhZGllbnQ+CiAgPHJlY3QgeD0iMCIgeT0iMCIgd2lkdGg9IjEiIGhlaWdodD0iMSIgZmlsbD0idXJsKCNncmFkLXVjZ2ctZ2VuZXJhdGVkKSIgLz4KPC9zdmc+);
                background: -moz-linear-gradient(top,  rgba(186,209,226,1) 0%, rgba(59,89,151,1) 100%); /* FF3.6+ */
                background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,rgba(186,209,226,1)), color-stop(100%,rgba(59,89,151,1))); /* Chrome,Safari4+ */
                background: -webkit-linear-gradient(top,  rgba(186,209,226,1) 0%,rgba(59,89,151,1) 100%); /* Chrome10+,Safari5.1+ */
                background: -o-linear-gradient(top,  rgba(186,209,226,1) 0%,rgba(59,89,151,1) 100%); /* Opera 11.10+ */
                background: -ms-linear-gradient(top,  rgba(186,209,226,1) 0%,rgba(59,89,151,1) 100%); /* IE10+ */
                background: linear-gradient(top,  rgba(186,209,226,1) 0%,rgba(59,89,151,1) 100%); /* W3C */
                filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#bad1e2', endColorstr='#3b5997',GradientType=0 ); /* IE6-8 */
                color: white;
                font-family: fb_font;
                font-size: 16px;
                font-weight: bold;

                border: 1px solid #1C4596;
                border-radius: 5px;

                padding: 5px;
                margin: 35px 10px 10px 10px;
            }
            ul {
                list-style-type: none;
                text-indent: 0px;
                left: 408px;
                width: 145px;
                padding: 0px;
                border: 1px solid #383f41;
                border-radius: 2px;
            }
            li {
                margin: 0px 0px 0px -30px;
                padding: 0px 0px 0px 32px;
                width: 135px;
                font-size: 11px;
                text-align: left;
                text-indent: 0px;
                height: 20px;
                background-color: white;
            }
            .ui-autocomplete {
                max-height: 100px;
                overflow-y: auto;
                /* prevent horizontal scrollbar */
                overflow-x: hidden;
                /* add padding to account for vertical scrollbar */
                padding-right: 20px;
                background-color: white;
            }
            /* IE 6 doesn't support max-height
             * we use height instead, but this forces the menu to always be this tall
             */
            * html .ui-autocomplete {
                height: 100px;
            }
            button .fb {
                font-family: fb_font;
                font-size: 40px;
                padding: 0px 8px 0px 0px;
                margin: 6px 0px 0px 0px;
                float: left;
                border-right: 1px solid #1C4596;
            }
            button p {
                float: left;
                margin: 15px 0px 0px 10px;
                padding: 0px;
            }
            #title_bar {
                width: 100%;
                height: 55px;
                border-bottom: 1px solid #616262;
            }
            #title_bar img {
                float: left;
                height: 50px;
                margin: 0px 0px 0px 6px;
                padding: 0px;
            }
            #title_bar h2 {
                font-size: 25px;
                margin: 0px -20px 0px 0px;
                padding: 10px;
            }
            #title_bar p {
                font-size: 10px;
                padding: 0px;
                margin: -10px 0px 0px 94px;
            }
            #fb_btns {
                height: 124px;
                color: #616262;
                background-color: #e9f0f0;
            }
            #fb_btns h3 {
                margin: 0px;
                padding: 30px 10px 0px 10px;
            }
            #cancel {
                float: right;
                width: 50%;
                height: 35px;
                background-color: #e9f0f0;
            }
            #cancel button {
                margin: 0px 17px 0px 0px;
                float: right;
            }
            #willet {
                float: right;
                width: 50%;
                height: 35px;
                background-color: #e9f0f0;
            }
            #willet p {
                float: left;
                font-size: 10px;
                margin-left: 17px;
            }
            #willet img {
                float: left;
                height: 20px;
                margin: 5px 10px 5px 3px;
            }
            #nameEntry {
                text-align: left;
                padding-left: 15px;
                border-bottom: 1px solid #616262;
            }
            #tags {
                width: 160px;
                margin-left: 2px;
            }
            #selectionCount {
                float: right;
                margin-right: 15px;
            }
            #chosenFriends {
                height: 112px;
                overflow-y: auto;
                text-align: left;
                padding: 0px 5px 0px 5px;
                background-color: #e9f0f0;
            }
            #chosenFriends p {
                padding-left: 10px;
            }
            #chosenFriends img {
                margin: 5px 5px 0px 5px;
                padding: 5px;
                border: 1px solid #3B5997;
                border-radius: 5px;
                background-color: #526EA6;
            }
            #shareText {
                padding: 0px 10px 0px 10px;
                background-color: #e9f0f0;
            }
            #share-text {
                font-size: 11px;
                margin-top: 5px;
                height: 35px;
            }
            #btns {
                text-align: right;
                font-size: 11px;
                background-color: #e9f0f0;
                margin: 0px;
                padding: 3px 7px 2px 10px;
                height: 24px;
            }
            #btns button {
               -webkit-appearance: none;
                -webkit-border-horizontal-spacing: 0px;
                -webkit-border-vertical-spacing: 0px;
                -webkit-box-align: center;
                -webkit-box-shadow:0 1px 2px #999;
                -moz-box-shadow:0 1px 2px #999;
                box-shadow:0 1px 2px #999;
                -webkit-rtl-ordering: logical;
                -webkit-user-select: text;
                background-attachment: scroll;
                background-clip: border-box;
                background-color: #EEE;
                background-image: none;
                background-origin: padding-box;
                background-position: 0% 0%;
                background-repeat: repeat;
                border-bottom-color: #888;
                border-bottom-style: solid;
                border-bottom-width: 1px;
                border-collapse: collapse;
                border-left-color: #999;
                border-left-style: solid;
                border-left-width: 1px;
                border-right-color: #999;
                border-right-style: soild;
                border-right-width: 1px;
                border-top-color: #999;
                border-top-style: soild;
                border-top-width: 1px;
                box-sizing: border-box;
                color: #333;
                cursor: pointer;
                direction: ltr;
                display: inline-block;
                float: none;
                font-family: 'Lucida Grande', Tahoma, Verdana, Arial, sans-serif;
                font-size: 13px;
                font-style: normal;
                font-variant: normal;
                font-weight: bold;
                letter-spacing: normal;
                line-height: normal;
                margin-bottom: 0px;
                margin-left: 10px;
                margin-right: 0px;
                margin-top: 0px;
                outline-color: #333;
                outline-style: none;
                outline-width: 0px;
                padding: 2px;
                text-align: center;
                text-decoration: none;
                text-indent: 0px;
                text-shadow: none;
                text-transform: none;
                unicode-bidi: normal;
                vertical-align: baseline;
                white-space: nowrap;
                word-spacing: 0px;
            }
        </style>
    </head>
    <body>
    <div id="wrapper">
        <div id="splash">
            <div id="title_bar">
                <img src="/static/imgs/sibt_logo.png" />
                <h2>Should I Buy This?</h2>
                <p>The fastest way to get shopping advice from friends & family</p>
            </div>

            <div id="fb_btns">
                <button title="Post to your wall" value="Ask All Friends" onclick="postOnWall()">
                    <p class="fb">f</p>
                    <p>Ask All Friends</p>
                </button>
                <button title="Post to your friends' walls" value="Choose Your Friends" onclick="chooseFriends()">
                    <p class="fb">f</p>
                    <p>Choose Which Friends</p>
                </button>
            </div>

            <div id="cancel">
                <button id="cancel-btn" title="Cancel" />Cancel</button>
            </div>
            <div id="willet">
                <p>Powered by</p>
                <a href="http://www.willetinc"><img src="/static/imgs/logo.png" /></a>
            </div>
        </div>

<!-- ---------------------------------------- -->

        <div id="friendPicker" style="display: none">
            <div id="nameEntry">
                <label for="tags">Find a Friend:</label>
                <input id="tags" />
                <label id="selectionCount"> Selected: 0</label>
            </div>

            <div id="chosenFriends">
                <p>Enter your friends' names at the top!</p>
            </div>
            
            <div id="shareText">
                <textarea id="share-text">{{ AB_share_text }}</textarea>
            </div>
            
            <div id="btns">
                <button id="email-btn" style="width:50px;" onClick="updateEmailAddress();">Ask</button>
                <button id="cancel-btn" onClick="window.close();">Cancel</button>
            </div>
        </div>
    </div>

    <div id="fb-root"></div>
    <script>
        window.fbAsyncInit = function() {
            // see: http://stackoverflow.com/questions/7655352/facebook-comment-fbcomment-returning-https-content-when-called-over-http
            //FB._https = true;
            FB.init({
                appId : '{{FACEBOOK_APP_ID}}', // App ID
                //channelURL : '//WWW.YOUR_DOMAIN.COM/channel.html', // Channel File
                status: true, // check login status
                cookie: true, // enable cookies to allow the server to access the session
                oauth : true, // enable OAuth 2.0
                xfbml : true  // parse XFBML
            });
        };

        (function(d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) {return;}
            js = d.createElement(s);
            js.id = id;
            js.async = true;
            js.src = "https://connect.facebook.net/en_US/all.js#xfbml=1";
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));
    </script>
</body>
</html>

