<!DOCTYPE html>
<html lang='en'>
    <head>
        <!-- Mixpanel -->
        <script type="text/javascript"> var mpq = []; mpq.push(["init", "{{MIXPANEL_TOKEN}}"]); (function() { var mp = document.createElement("script"); mp.type = "text/javascript"; mp.async = true; mp.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + "//api.mixpanel.com/site_media/js/api/mixpanel.js"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(mp, s); })(); </script>
        <!-- End Mixpanel -->
        
        <!-- Google Analytics -->
        <script type="text/javascript">
            var _gaq = _gaq || [];
            _gaq.push(['_setAccount', 'UA-23764505-9']);
            _gaq.push(['_trackPageview']);
            (function() {
                var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
                ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
            })();
        </script>
        
        <!-- Favicon -->
        <link rel='icon' type='image/vnd.microsoft.icon' href='/static/imgs/favicon.ico' />
        
        <meta http-equiv="X-UA-Compatible" content="IE=8" />
        <meta http-equiv='Content-Type' content='text/html;charset=utf-8' />
        <title>Social Referral</title>
        <meta name="description" content="What's the social value of your users?" />
        <meta name="keywords" content="social value, social payment, social worth, twitter value, twitter account value,
        tweet value, twittervalue, tweetvalue, social payments, twitter worth" />
        <link rel="start" href="http://www.wil.lt" title="Willet Social" />
        {% include "javascript_includes.html" %}
        
        <script type="text/javascript">
            
            var share, reset, countChars, willet_conversion, sendGmail, sendEmailiframeBody,
                shareArea, shareFrame, shareText, charsLeft, clear, shareComplete, fbToken;
            
            window.onload = function() {
            
                iframeBody = document.getElementById('willt');
                shareFrame = document.getElementById('willt-frame');
                shareArea = document.getElementById('share-area'),
                userFound = {% if user_founder %}{{ user_found }}{% else %}false{% endif %};
                shareText = document.getElementById('share-text'),
                charsLeft = document.getElementById('chars-left');

                if ( FB ) {
                    FB.init({ appId: '{{FACEBOOK_APP_ID}}',
                        status: true,
                        cookie: true,
                        xfbml: true,
                        oauth: true
                    });
                }
        
                // clear the share text
                shareComplete = function() {
                    console.log("Sharing complete!");
                    shareText.value = 'Thanks for sharing!';
                    return true;
                };
            
                willet_conversion = function () {
                    $.ajax({
                        url: "/conversion",
                        type: 'post',
                        data: { referree_uid : "{{supplied_user_id}}",
                                campaign_uuid : "{{campaign_uuid}}" }
                    });// end ajax
                }; 
            
                clearText = function( elem ) {
                    elem.value = "";
                };
            
                errorCheckEmails = function (from, to, msg) {
                    var ret = true;
                    var emailPattern = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/;  
            
                    if( !emailPattern.test(from.value) ) {
                        from.value = "Please enter your email address.";
                        ret = false; 
                    }  
                
                    if ( to.value == "" ) {
                        to.value = "Please enter your friends' email addresses!";
                        ret = false;
                    }
                
                    if ( msg.value == "" ) {
                        msg.value = "Enter a message for your friends!";
                        ret = false;
                    }
                    return ret;
                }
            
                mixpanelTrack = function( event ) {
                    var user_id = {% if user %}
                                    "{{user.uuid}}"
                                  {% else %} 
                                    document.getElementById( 'from-email' );
                                  {% endif %}
            
                    // Track for the Client
                    mpq.push(['track', event + "{{campaign_uuid}}", 
                                      {'user'     : user_id, 
                                       'campaign' : "{{campaign_uuid}}",
                                       'bucket'   : "{{campaign_uuid}}"}]);
                
                    // Track for us
                    mpq.push(['track', event, {'user'     : user_id, 
                                               'campaign' : "{{campaign_uuid}}",
                                               'bucket'   : "{{campaign_uuid}}"}]);
                
                }
        
                sendEmailVia = function( who ){
                    var from_addr = document.getElementById( 'from-email' ),
                        to_addrs  = document.getElementById( 'to-emails' ).value,
                        msg       = document.getElementById( 'email-share-text' ).value,
                        str;

                    // Tell the Server
                    if ( !sendEmail( false ) ) {
                        return;
                    }

                    if ( who === 'gmail' ) {
                        // Make a Gmail String
                        str = 'https://mail.google.com/mail/?view=cm&fs=1' +
                              '&to=' + to_addrs + 
                              '&su=' + "Check This Out!" + 
                              '&body=' + msg.replace(/\n/g,'%0A') + 
                              '&ui=2&tf=1';

                        mixpanelTrack( 'Gmail' );

                    } else if (who === 'yahoo') {
                        // Make a Yahoo string
                        str = "http://us.mc1216.mail.yahoo.com/mc/compose?.rand=1915749995" + 
                              "&to=" + to_addrs +
                              "&subject=" + "Check This Out!" + 
                              '&body=' + msg.replace(/\n/g,'%0A');

                        mixpanelTrack( 'Yahoo' );

                    } else if (who === 'hotmail') {
                        str = 'http://by156w.bay156.mail.live.com/default.aspx?rru=compose' + 
                              "&to=" + to_addrs +
                              "&subject=" + "Check This Out!" + 
                              '&body=' + msg.replace(/\n/g,'%0A');
                
                        mixpanelTrack( 'Hotmail' );
                    } else if (who === 'aol') {
                        str = "http://mail.aol.com/34007-211/aol-6/en-us/mail/compose-message.aspx?" + 
                              "&to=" + to_addrs +
                              "&subject=" + "Check This Out!" + 
                              '&body=' + msg.replace(/\n/g,'%0A');
                
                        mixpanelTrack( 'AOL' );
                    }
                    window.open( str );
                };

                sendEmail = function( via_willet ) {
                    var from_addr = document.getElementById( 'from-email' ),
                        to_addrs  = document.getElementById( 'to-emails' ),
                        msg       = document.getElementById( 'share-text' );
            
                    // Check the fields.
                    if ( !errorCheckEmails(from_addr, to_addrs, msg) ) {
                        return false;
                    }
            
                    $.ajax({url: "/sendEmailInvites",
                        type: 'post',
                        data: { from_addr : from_addr.value, 
                                to_addrs  : to_addrs.value,
                                msg       : msg.value,
                                url       : "{{willt_url}}",
                                willt_url_code : "{{willt_code}}",
                                via_willet : via_willet },
                        success: function(msg) {
                            var to_addrs  = document.getElementById( 'to-emails' ),
                                msg       = document.getElementById( 'share-text' );
                        
                            to_addrs.value = "";
                            msg.value = "Thank You! Invites sent!";
                        }
                    });// end ajax
            
                    // Track 'email' event
                    mixpanelTrack( 'Email' );
                    // Also track more general 'share' event
                    mixpanelTrack( 'Share' );
                    return true;
                };

                toggleEmailShare = function( type ) {
                    var $email_div = $('#email_div');
                    if ( $email_div.is(":visible") ) {
                        $email_div.slideUp();
                    } else {
                        $email_div.slideDown();
                    }
                };

                // use the selected medium to share about your purchase
                share = function(medium, uid) {
                    var fb_share_handler = function(payload) {
                        $.ajax({url: "/fbShare",
                                type: 'post',
                                data: payload,
                                success: function (tr) {
                                    if (tr === 'ok') {
                                        shareComplete();
                                    } else {
                                        console.log("Facebook post failure");
                                    }
                                }
                        });
                    },
                    uid = uid || '';
                    var message = shareText.value.substring(0,141);
                    if (['linkedin', 'twitter', 'fb'].indexOf(medium) !== -1) {
                        // initiate facebook login event if requested
                        if (medium === 'fb') {
                            var fbData = {msg: message, wcode: '{{willt_code}}'};
                            // first attempt server-provided token
                            if (userFound) {
                                fb_share_handler(fbData)
                                return;
                            } else {
                                if (!FB) {
                                    alert("Sorry Facebook appears to be down for the moment. Please try again in a bit.");
                                    return;
                                }
                                FB.login(function(lr) {
                                        if (!lr.authResponse) {
                                            // we weren't given permission
                                            window.close();
                                        } else { 
                                            fbData.fb_token = lr.authResponse.accessToken;
                                            fbData.fb_id = lr.authResponse.userID;
                                            fb_share_handler(fbData);
                                            mixpanelTrack( 'Facebook' );
                                            mixpanelTrack( 'Share' );
                                        }
                                    }, {scope: 'publish_stream,offline_access,user_about_me,email'}
                                );
                    
                            } // if (userFound u
                        } else if (medium === 'twitter'){
                            var OAuthURL = '{{URL}}/oauth/twitter/login?wuid='
                                            + '&m=' + message + '&wcode={{willt_code}}',
                                            AuthWindow = window.open(OAuthURL, '_blank');
                        } else if (medium === 'linkedin') {
                            console.log('linkedin share', message);
                            var OAuthURL = '{{URL}}/oauth/linkedin/login?wuid='
                                            + '&m=' + message + '&wcode={{willt_code}}',
                                            AuthWindow = window.open(OAuthURL, '_blank');       
                        } else if (medium === 'twitter'){
                            var OAuthURL = '{{URL}}/oauth/twitter/login?wuid='
                                            + '&m=' + message + '&wcode={{willt_code}}',
                                AuthWindow = window.open(OAuthURL, '_blank');
                        } else {
                            // style shareArea according to different social loader
                        }
                        shareArea.style.visibility = 'visible';
                    } else {
                        // social media provider not found
                    }
                };
            
                countChars = function() {
                    var count = 140 - shareText.value.length;
                    charsLeft.innerHTML = count + " characters left";
                };
        
                reset = function() { 
                    iframeBody.style.visibility = 'visible';
                    shareArea.style.visibility = 'hidden';
                    shareFrame.src = '';
                };
        
                function toggleDefaultValue ($this, onoff) {
                    if (onoff) {
                        $this.css('color', '#777');
                        $this.val($this.siblings('.defaultValue').attr('innerHTML'));
                    } else {
                        $this.css('color', '#444');
                        $this.val('');
                    }
                } // end function
            
                // Controls default values of input & textarea elements
                $('.defaultValue').siblings('input, textarea').each(
                    function () { 
                        var $this = $(this);
                        if ($this.val() === '') {
                            toggleDefaultValue($this, true); 
                        }
                    }
                ).focus(
                    function () {
                        var $this = $(this),
                            defaultValue = $this.siblings('.defaultValue').attr('innerHTML');
                        if ($this.val() === defaultValue) {
                            toggleDefaultValue($this, false);
                        }
                    }
                ).blur(
                    function () { 
                        var $this = $(this);
                        if ($this.val() === '' ) {
                            toggleDefaultValue($this, true);
                        }
                    }
                );
            
                countChars();
                willet_conversion();
            };
        </script>
            
        <!-- Blueprint CSS -->
        <link rel="stylesheet" href="/static/css/blueprint/screen.css" type="text/css" media="screen, projection" />
        <link rel="stylesheet" href="/static/css/blueprint/print.css" type="text/css" media="print" />
        <!--[if IE]><link rel="stylesheet" href="blueprint/ie.css" type="text/css" media="screen, projection" /><![endif]-->
        <style>
            .willt {
                text-align: center;
                padding: 10px 10px 10px 10px;
                margin: 0px 0px 0px 0px;
                /*background-color: #f4faff; */
            
                border: 1px solid #AECEEF;
                -khtml-box-shadow: inset 0 0 2px #AECEEF;
                -o-box-shadow: inset 0 0 2px #AECEEF;
                -webkit-box-shadow: inset 0 0 2px #AECEEF;
                -moz-box-shadow: inset 0 0 2px #AECEEF;
                -khtml-border-radius: 5px;
                -o-border-radius: 5px;
                -webkit-border-radius: 5px;
                -moz-border-radius: 5px;
                border-radius: 5px;
                float: none;
            }
            a, a * { 
                cursor: pointer;
                outline: none; 
                text-decoration: none;
            }
            h1 {
                font-size: 2.0em;
            }
            h2 {
                font-size: 1.5em;
            }
            h1, h2, h3, h4, h5 { 
                color: #1f75cc;
                margin: 0 0 5px 0;
                padding: 0px 0px 0px 0px;
                line-height: 1.6em;
                font-weight: bold;
            }
            body, input,textarea,select, .normal {
                font-family: "lucida grande", "Segoe UI", arial, verdana, "lucida sans unicode", tahoma, sans-serif;
                font-size: 8pt; 
                color: #444; 
                font-weight: normal;
            }
            label {
                cursor: default;
            }
            textarea {
                background: #fff url("/static/inputshadow.gif") repeat-x top; 
                border-style: none solid solid;
                vertical-align: middle; 
                border: 1px solid #aaa; 
                Padding: 4px; 
                color: #555;
                margin: 0px 0px 0px 0px;
                max-height: 75px;
                max-width: 340px;
            }
            a {
                display: -moz-inline-stack;
                display: inline-block !important;
                position: relative;
                color: #1f75cc;
                background-color: #fafcff;
                margin: 1px -1px 0 0; 
                border: 1px solid #aeceef;
                border-width: 1px 1px;  
                _padding: 3px; 
                _border-width: 1px; 
                _display: inline;  
                height: 23px; 
                line-height: 23px;
                padding: 1px 10px 1px 10px; 
                _border:none;
            }
            a:hover { 
                color: #1f75cc;
                text-decoration: none;
                border-color: #4291df; 
                position: relative; 
                z-index:2;
            }
            a:active {
                background-color: #4291df;
                color: #fff;
            }
            input {
                background: #fff url("/static/inputshadow.gif") repeat-x top; 
                padding: 4px;
            }
            .right {
                text-align: right;
                float: right;
            }
            .clear {
                clear: both;
            }
            div#use_us {
                padding: 0;
                margin: 0;
                line-height: 30px;
            }
            #chars-left {
                font-size: 0.8em;
                text-align: right;
                float: right;
            }
            a img {
                float: left;
                height: 20px;
                padding: 0px 5px 0px 5px;
                margin-top: 1px;
            }
            a div {
                padding: 0px 0px 0px 0px;
                float: left;
                margin-top: -1px;
            }
            .email_btn {
                padding: 0px 0px 3px 0px;
            }
            .email_btn img {
                padding: 2px 5px 2px 5px;
            }
            .choose_btn {
                padding: 0px 20px 0px 20px;
            }
            .input-label {
                float: left;
                line-height: 33px;
            }
            .input-content {
                float: right;
            }
            .input-content input {
                float: right;
                width: 260px;
            }
            #share-area {
                visibility: hidden;
            }
            #share-text {
                margin: 5px 0px 5px 0px;
            }
            .hidden {
                display: none;
            }
            .social {
                float: right;
                margin: 0px 0px 0px 0px;
                padding: 0px 0px 0px 0px;
            }
            .hor_line {
                height: 1px;
                width: 300px;
                margin-left: auto;
                margin-right: auto;
                background-color: #AECEEF;
                margin-top: 15px;
                margin-bottom: 5px;
                padding: 0px 0px 0px 0px;
            }
        </style>
    </head>
    <body>

    <div id="fb-root"></div>

    {% block top %} {% endblock top %}
    
    <div class="prepend-top span-9 append-15 last willt">
        <div class="span-9 last">
            <h2 id="plugin-title">Invite Your Friends To {{campaign.product_name}}</h2>
            
            <div class="prepend-5 span-4 last" id="chars-left">140 characters left</div>
            <textarea wrap="soft" id="share-text" onkeydown="countChars();">{{ text }}</textarea>

            <div class="span-9 last" id="choose_share_type">
                <a href="#" onClick="toggleEmailShare();" title="Share using your email account or let us email for you!"> 
                    <img src="/static/imgs/email_logo.png" width="27px" height="20px" />
                </a>
                <a href="#" title="Share on Facebook" onclick="share('fb');">
                    <img src="/static/imgs/fb-logo.png" width="20px" height="20px" />
                    
                </a>
                <a href="#" title="Tweet on Twitter" onclick="share('twitter');">
                    <img src="/static/imgs/twitter-logo.png" width="20px" height="20px" />
                    
                </a>
                <a href="#" title="Share on LinkedIn" onclick="share('linkedin');">
                    <img src="/static/imgs/linkedin-logo.png" width="20px" height="20px" />
                </a>
            </div>
        </div>

        <div class="prepend-top span-9 last hidden" id="email_div">
            <div class="span-9 last">
                <div class="input-label">Your Email</div>
                <div class="input-content">
                    <span class="defaultValue hidden">your email</span>
                    <input id="from-email" type="text" name="email" value="{{ user_email }}" />
                </div>
            </div>
            <div class="span-9 append-bottom last">
                <div class="input-label">Invitee Emails</div>
                <div class="input-content">
                    <span class="defaultValue hidden">Email addresses, separated by commas.</span>
                    <input id="to-emails" type="text" value="" />
                </div>
            </div>
            
            <div class="span-5"> &nbsp;Choose your email provider: </div>
            <div class="span-4 last right"> Or, let us email it for you:</div>
            <div class="span-5" style="margin-top: 5px;" >
                <a class="email_btn" href="#" onClick="sendEmailVia( 'gmail' );" title="GMail"> 
                    <img src="/static/imgs/gmail_logo.png" width="25px" height="20px" />
                </a>
                <a class="email_btn" href="#" onClick="sendEmailVia( 'hotmail' );" title="Hotmail"> 
                    <img src="/static/imgs/hotmail_logo.png" width="29px" height="20px" />
                </a>
                <a class="email_btn" href="#" onClick="sendEmailVia( 'yahoo' );" title="Yahoo Mail"> 
                    <img src="/static/imgs/yahoo_mail_logo.png" width="27px" height="20px" />
                </a>
                <a class="email_btn" href="#" onClick="sendEmailVia( 'aol' );" title="AOL Mail"> 
                    <img src="/static/imgs/aol_mail_logo.png" width="27px" height="20px" />
                </a>
            </div>
            <div class="span-4 last" style="margin-top: 5px;">
                <div class="right">
                    <a class="email_btn" href="#" onClick="sendEmail(true);" title="We will send an email on your behalf"> 
                        <img src="/static/imgs/email_logo.png" width="27px" height="20px" />
                    </a>
                </div>
                <div class="clear"></div>
            </div>
        </div>

        <div class="span-9 last hidden" id="by-fb-twitter">
            <div class="span-9 last">
                <a href="#" onclick="share('fb');">
                    <img src="/static/imgs/fb-logo.png" width="20px" height="20px" />
                </a>
                <a href="#" title="Tweet on Twitter" onclick="share('twitter');">
                    <img src="/static/imgs/twitter-logo.png" width="20px" height="20px" />
                </a>
            </div>
        </div>

        <div class="span-9 last"> 
            <hr class="hor_line" />
            Or, share your unique link:&nbsp;&nbsp;&nbsp;&nbsp;
            <input id="unique_link" type="text" value="{{ willt_url }}" readonly="readonly" />
        </div>
    </div>
    <div id="tweet-complete" onclick="shareComplete();"></div>
    <div id="share-area">
        <iframe id="willt-frame"></iframe>
    </div>
  </body>
</html>
